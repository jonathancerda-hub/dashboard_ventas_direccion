{% extends 'base.html' %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Header con logo y t√≠tulo -->
<div class="dashboard-header">
    <div class="header-left">
        <div class="header-info">
            <!-- El logo se movi√≥ al CSS como fondo para un look m√°s limpio -->
            <h1>AVANCE DE VENTAS - {{ mes_nombre.upper() }}</h1>
            <span class="header-username">{{ session.user_name }}</span>
        </div>
    </div>

    <!-- Calendario central -->
    <a id="date-picker-trigger" class="calendario-dia" style="cursor: pointer; text-decoration: none;">
        <div class="dia-numero">{{ dia_actual }}</div>
        <div class="dia-texto">{{ mes_nombre.split()[0][:3] }}</div>
    </a>

    <div class="header-nav">
        <select id="a√±o-selector" onchange="cambiarA√±o(this.value)" style="margin-right: 10px;">
            {% for a√±o in a√±os_disponibles %}
            <option value="{{ a√±o }}" {% if a√±o==a√±o_seleccionado %}selected{% endif %}>
                {{ a√±o }}
            </option>
            {% endfor %}
        </select>
        <select id="mes-selector" onchange="cambiarMes(this.value)">
            {% for mes in meses_disponibles %}
            <option value="{{ mes.key }}" {% if mes.key==mes_seleccionado %}selected{% endif %}>
                {{ mes.nombre }}
            </option>
            {% endfor %}
        </select>
        <a href="{{ url_for('logout') }}" class="btn-salir"><i class="bi bi-box-arrow-right"></i> Salir</a>
    </div>
</div>

<script>
    // Funci√≥n para cambiar a√±o
    function cambiarA√±o(a√±oSeleccionado) {
        // Obtener el par√°metro mes actual si existe
        const urlParams = new URLSearchParams(window.location.search);
        const mesActual = urlParams.get('mes');
        
        // Si hay un mes seleccionado, cambiar solo el a√±o en el mes
        if (mesActual) {
            const partes = mesActual.split('-');
            const nuevoMes = `${a√±oSeleccionado}-${partes[1]}`;
            window.location.href = `?a√±o=${a√±oSeleccionado}&mes=${nuevoMes}`;
        } else {
            // Si no hay mes, solo aplicar el filtro de a√±o
            window.location.href = `?a√±o=${a√±oSeleccionado}`;
        }
    }
    
    // Funci√≥n para cambiar mes - Definida temprano para el selector
    function cambiarMes(mesSeleccionado) {
        const urlParams = new URLSearchParams(window.location.search);
        const a√±oActual = urlParams.get('a√±o') || '{{ a√±o_seleccionado }}';
        window.location.href = `?a√±o=${a√±oActual}&mes=${mesSeleccionado}`;
    }
</script>

<!-- Dashboard principal -->
<div class="dashboard-container">
    <!-- Fila superior - KPIs principales -->
    <div class="kpi-row">
        <div class="kpi-card kpi-meta">
            <div class="kpi-label">Meta</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.meta_total) }}</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Venta</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.venta_total) }}</div>
        </div>

        <div class="kpi-card kpi-avance">
            <div class="kpi-label">% Avance</div>
            <div class="kpi-value">{{ "{:.1f} %".format(kpis.porcentaje_avance) }}</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Meta IPN</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.meta_ipn) }}</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Venta IPN</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.venta_ipn) }}</div>
        </div>

        <div class="kpi-card kpi-avance">
            <div class="kpi-label">% Avance IPN</div>
            <div class="kpi-value">{{ "{:.1f} %".format(kpis.porcentaje_avance_ipn) }}</div>
        </div>
        <!-- Proyecci√≥n lineal y faltante movidas a Avance Diario (ver m√°s abajo) -->
    </div>

    <!-- FILA 1: TABLA PRINCIPAL COMENTADA - Los datos siguen carg√°ndose en el backend -->
    <!-- 
    <div class="main-table-row">
        <div class="tabla-container">
            <div class="tabla-header">
                <h3>Meta LC Total y Venta por L√≠nea Comercial Local</h3>
                {% if is_admin %}
                    <div class="tabla-header-botones">
                        <a href="{{ url_for('export_dashboard_details', mes=mes_seleccionado, dia_fin=dia_actual) }}" class="btn-export-tabla">
                            <i class="bi bi-file-earmark-excel"></i> Exportar Detalle
                        </a>
                    </div>
                {% endif %}
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th>L√≠nea Comercial</th>
                        <th>Meta</th>
                        <th>Venta</th>
                        <th>% Cump</th>
                        <th>% Total Vta.</th>
                        <th>Meta IPN</th>
                        <th>Venta IPN</th>
                        <th>% Cump IPN</th>
                        <th>Venc &lt;6 mss</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in datos_lineas_tabla %}
                    <tr>
                        <td>
                            <a href="{{ url_for('dashboard_linea', linea_nombre=linea.nombre, mes=mes_seleccionado) }}" title="Ver dashboard de vendedores para {{ linea.nombre }}">
                                {{ linea.nombre }}
                            </a>
                        </td>
                        <td>{{ "{:,.0f}".format(linea.meta) }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta) }}</td>
                        <td class="porcentaje">{{ "{:.1f}%".format(linea.porcentaje_total) }}</td>
                        <td class="porcentaje">{{ "%.1f%%"|format(linea.porcentaje_sobre_total) }}</td>
                        <td>{{ "{:,.0f}".format(linea.meta_pn) }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta_pn) }}</td>
                        <td class="porcentaje">{{ "{:.1f}%".format(linea.porcentaje_pn) }}</td>
                        <td><strong>{{ "{:,.0f}".format(linea.vencimiento_6_meses) }}</strong></td>
                    </tr>
                    {% endfor %}
                    <tr class="fila-total">
                        <td><strong>Total</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.meta_total) }}</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.venta_total) }}</strong></td>
                        <td class="porcentaje"><strong>{{ "{:.1f}%".format(kpis.porcentaje_avance) }}</strong></td>
                        <td class="porcentaje"><strong>100.0%</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.meta_ipn) }}</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.venta_ipn) }}</strong></td>
                        <td class="porcentaje"><strong>{{ "{:.1f}%".format(kpis.porcentaje_avance_ipn) }}</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.vencimiento_6_meses) }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    -->

    <!-- FILA 2: DOS TABLAS LADO A LADO -->
    <div class="secondary-content-row">
        <!-- Tabla de L√≠neas Comerciales (IZQUIERDA) -->
        {% if datos_lineas_tabla %}
        <div class="tabla-container tabla-ecommerce">
            <div class="tabla-header">
                <h3>Ventas por L√≠nea Comercial</h3>
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th style="width: 50%;">L√≠nea Comercial</th>
                        <th style="width: 25%;">s/ Facturado</th>
                        <th style="width: 25%;">% Total Vta.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in datos_lineas_tabla %}
                    <tr>
                        <td>{{ linea.nombre }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta) }}</td>
                        <td class="porcentaje">{{ "%.1f%%"|format(linea.porcentaje_sobre_total) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="fila-total">
                        <td><strong>Total</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.venta_total) }}</strong></td>
                        <td class="porcentaje"><strong>100.0%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Tabla de Clientes por L√≠nea Comercial (DERECHA) -->
        {% if datos_clientes_por_linea %}
        <div class="tabla-container tabla-ecommerce">
            <div class="tabla-header">
                <h3>An√°lisis de Clientes por L√≠nea Comercial</h3>
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th style="width: 40%;">L√≠nea Comercial</th>
                        <th style="width: 20%;">s/ Facturado</th>
                        <th style="width: 20%;">N¬∞ Clientes</th>
                        <th style="width: 20%;">Ticket/Cliente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in datos_clientes_por_linea %}
                    <tr>
                        <td>{{ linea.nombre }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta) }}</td>
                        <td>{{ linea.num_clientes }}</td>
                        <td>{{ "{:,.0f}".format(linea.ticket_promedio) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Gr√°fico de Cobertura de Clientes -->
    <div class="grafico-container" style="margin-top: 30px;">
        <div class="tabla-header">
            <h3>üìä Cobertura de Clientes</h3>
        </div>

        <!-- Grid de 2 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px;">
            <!-- Columna 1: Gauge de cobertura SVG mejorado -->
            <div class="grafico-container" style="margin: 0;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Indicador General</h4>
                </div>
                <div
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div class="cobertura-gauge" style="position: relative;">
                        <svg width="320" height="320" viewBox="0 0 320 320"
                            style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                            <!-- C√≠rculo de fondo con gradiente -->
                            <defs>
                                <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#f0f0f0;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:1" />
                                </linearGradient>

                                <!-- Gradiente para el progreso -->
                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#ff4d4f;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#ff7a45;stop-opacity:1" />
                                    <stop offset="65%" style="stop-color:#faad14;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#52c41a;stop-opacity:1" />
                                </linearGradient>
                            </defs>

                            <!-- C√≠rculo de fondo -->
                            <circle cx="160" cy="160" r="130" fill="none" stroke="url(#gaugeGradient)" stroke-width="28"
                                opacity="0.3" />

                            <!-- Marcadores de objetivos con l√≠neas m√°s visibles -->
                            <!-- 50% -->
                            <line x1="160" y1="30" x2="160" y2="55" stroke="#ff4d4f" stroke-width="4" opacity="0.8" />
                            <text x="160" y="20" text-anchor="middle" fill="#ff4d4f" font-size="13"
                                font-weight="700">50%</text>

                            <!-- 65% -->
                            <line x1="252" y1="66" x2="235" y2="83" stroke="#faad14" stroke-width="4" opacity="0.9" />
                            <text x="270" y="65" text-anchor="middle" fill="#faad14" font-size="13"
                                font-weight="700">65%</text>

                            <!-- 70% -->
                            <line x1="278" y1="118" x2="258" y2="128" stroke="#52c41a" stroke-width="4" opacity="0.9" />
                            <text x="298" y="122" text-anchor="middle" fill="#52c41a" font-size="13"
                                font-weight="700">70%</text>

                            <!-- C√≠rculo de progreso animado -->
                            <circle id="coberturaCircle" cx="160" cy="160" r="130" fill="none" stroke-width="28"
                                stroke-dasharray="817" stroke-dashoffset="817" stroke-linecap="round"
                                transform="rotate(-90 160 160)"
                                style="transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease;" />

                            <!-- C√≠rculo central decorativo -->
                            <circle cx="160" cy="160" r="100" fill="white" opacity="0.95"
                                style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));" />
                        </svg>

                        <!-- Texto centrado sobre el SVG -->
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 180px;">
                            <div id="coberturaValue"
                                style="font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px; transition: color 0.3s ease;">
                                {{ kpis.cobertura_clientes|round(1) }}%
                            </div>
                            <div id="coberturaLabel"
                                style="font-size: 16px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                                Cobertura
                            </div>
                        </div>
                    </div>

                    <!-- Leyenda de objetivos debajo del gauge -->
                    <div
                        style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 12px; width: 100%; max-width: 300px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #333; text-align: center;">Objetivos
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                            <div><span style="color: #ff4d4f;">‚óè</span>
                                <50% Bajo</div>
                                    <div><span style="color: #ff7a45;">‚óè</span> 50-65% Regular</div>
                                    <div><span style="color: #faad14;">‚óè</span> 65-70% Meta</div>
                                    <div><span style="color: #52c41a;">‚óè</span> 70%+ Excelente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna 2: Tabla de cobertura por canal -->
                <div class="grafico-container" style="margin: 0;">
                    <div class="tabla-header" style="margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 16px;">Cobertura por Canal</h4>
                    </div>
                    <div style="overflow-y: auto; max-height: 400px;">
                        <table class="tabla-avance" style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Canal</th>
                                    <th style="width: 22%;">Cartera</th>
                                    <th style="width: 22%;">Activos</th>
                                    <th style="width: 21%;">Cobertura</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for canal in datos_cobertura_canal %}
                                <tr {% if canal.get('es_total')
                                    %}style="background: #f0f2f5; font-weight: 700; border-top: 2px solid #875A7B;" {%
                                    endif %}>
                                    <td><strong>{{ canal.canal }}</strong></td>
                                    <td style="text-align: center;">{{ canal.cartera }}</td>
                                    <td style="text-align: center;">{{ canal.activos }}</td>
                                    <td style="text-align: center;">
                                        <span style="
                                        font-weight: 700;
                                        font-size: 14px;
                                        color: {% if canal.cobertura >= 70 %}#52c41a{% elif canal.cobertura >= 65 %}#faad14{% elif canal.cobertura >= 50 %}#ff7a45{% else %}#ff4d4f{% endif %};
                                    ">
                                            {{ "{:.1f}".format(canal.cobertura) }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Leyenda de objetivos debajo de la tabla -->
                    <div
                        style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #333; text-align: center;">Objetivos
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                            <div><span style="color: #ff4d4f;">‚óè</span>
                                <50% Bajo</div>
                                    <div><span style="color: #ff7a45;">‚óè</span> 50-65% Regular</div>
                                    <div><span style="color: #faad14;">‚óè</span> 65-70% Meta</div>
                                    <div><span style="color: #52c41a;">‚óè</span> 70%+ Excelente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f2f5; border-radius: 8px; color: #666; font-size: 14px;">
                    <strong style="color: #875A7B;">{{ kpis.clientes_activos }}</strong> clientes activos de
                    <strong style="color: #875A7B;">{{ kpis.total_clientes_cartera }}</strong> en cartera del a√±o {{
                    fecha_actual.year }}
                </div>
            </div>

            <!-- Gr√°fico de Frecuencia de Compra -->
            <div class="grafico-container" style="margin-top: 30px;">
                <div class="tabla-header">
                    <h3>üîÑ Frecuencia de Compra</h3>
                </div>

                <!-- Grid de 2 columnas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px;">
                    <!-- Columna 1: Gr√°fico de barras -->
                    <div class="grafico-container" style="margin: 0;">
                        <div class="tabla-header" style="margin-bottom: 15px;">
                            <h4 style="margin: 0; font-size: 16px;">Frecuencia por L√≠nea Comercial</h4>
                        </div>
                        {% if datos_frecuencia_linea and datos_frecuencia_linea|length > 1 %}
                        <div id="graficoFrecuenciaLinea" style="width: 100%; height: 400px;"></div>
                        {% else %}
                        <div
                            style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">
                            No hay datos suficientes para mostrar el gr√°fico.
                        </div>
                        {% endif %}

                        <!-- Explicaci√≥n del KPI -->
                        <div
                            style="margin-top: 15px; padding: 12px; background: #e6f7ff; border-left: 4px solid #1890ff; border-radius: 4px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 6px; color: #0050b3;">¬øQu√© mide?</div>
                            <div style="color: #333; line-height: 1.5;">
                                La frecuencia refleja qu√© tan seguido cada cliente vuelve a requerir nuestros productos.
                                Si est√° en 1, significa que compran solo 1 vez al mes; si sube a 2 o m√°s, este cliente
                                vuelve y depende de nosotros.
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2: Tabla de frecuencia por l√≠nea -->
                    <div class="grafico-container" style="margin: 0;">
                        <div class="tabla-header" style="margin-bottom: 15px;">
                            <h4 style="margin: 0; font-size: 16px;">Detalle por L√≠nea</h4>
                        </div>
                        <div style="overflow-y: auto; max-height: 400px;">
                            <table class="tabla-avance" style="font-size: 13px;">
                                <thead>
                                    <tr>
                                        <th style="width: 35%;">L√≠nea Comercial</th>
                                        <th style="width: 20%;">N¬∞ Clientes</th>
                                        <th style="width: 20%;">Q Pedidos</th>
                                        <th style="width: 25%;">Frecuencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for linea in datos_frecuencia_linea|default([]) %}
                                    <tr {% if linea.get('es_total')
                                        %}style="background: #f0f2f5; font-weight: 700; border-top: 2px solid #875A7B;"
                                        {% endif %}>
                                        <td><strong>{{ linea.linea }}</strong></td>
                                        <td style="text-align: center;">{{ linea.clientes_activos }}</td>
                                        <td style="text-align: center;">{{ linea.pedidos }}</td>
                                        <td style="text-align: center;">
                                            <span style="
                                        font-weight: 700;
                                        font-size: 14px;
                                        color: {% if linea.frecuencia >= 2 %}#52c41a{% elif linea.frecuencia >= 1 %}#faad14{% else %}#ff4d4f{% endif %};
                                    ">
                                                {{ "{:.2f}".format(linea.frecuencia) }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: #999; padding: 20px;">
                                            No hay datos disponibles para este mes
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Objetivo vs Bench -->
                        <div
                            style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #333; text-align: center;">Objetivo
                                vs Bench</div>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 6px; font-size: 11px;">
                                <div><span style="color: #ff4d4f;">‚óè</span>
                                    <1 pedido/mes ‚Üí riesgo (cliente ocasional)</div>
                                        <div><span style="color: #faad14;">‚óè</span> 1-2 pedidos/mes ‚Üí est√°ndar industria
                                        </div>
                                        <div><span style="color: #52c41a;">‚óè</span> 2-3 pedidos/mes ‚Üí muy bueno
                                            (recurrencia saludable)</div>
                                </div>
                            </div>

                            <!-- Asegura -->
                            <div
                                style="margin-top: 15px; padding: 12px; background: #fff7e6; border-left: 4px solid #faad14; border-radius: 4px; font-size: 12px;">
                                <div style="font-weight: 600; margin-bottom: 6px; color: #d48806;">Asegura:</div>
                                <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                                    <li>Anticipar ingresos: clientes con frecuencia alta generan ventas m√°s predecibles
                                    </li>
                                    <li>Medir fidelidad real: m√°s pedidos, m√°s confianza en nuestra marca</li>
                                    <li>Identificar oportunidades: clientes de baja frecuencia son los que a√∫n pueden
                                        crecer</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tendencia Hist√≥rica de Ventas (12 meses) -->
                <div class="grafico-container" style="margin-top: 30px;">
                    <div class="tabla-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>üìà Tendencia Hist√≥rica de Ventas (12 Meses)</h3>
                            <span style="font-size:13px; color:#1890ff; font-weight:500; margin-left:10px;">(Siempre anual, no depende del filtro de mes)</span>
                        </div>
                        {% if a√±o_seleccionado < a√±o_actual %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="compararA√±oSiguiente" style="cursor: pointer; width: 18px; height: 18px;">
                            <label for="compararA√±oSiguiente" style="cursor: pointer; font-size: 14px; font-weight: 500; color: #333; margin: 0;">
                                Comparar con {{ a√±o_seleccionado + 1 }}
                            </label>
                        </div>
                        {% endif %}
                    </div>

                    <div style="margin-top: 20px; position: relative;">
                        {% if tendencia_12_meses and tendencia_12_meses|length > 0 %}
                        <div style="position: relative; height: 420px; width: 100%; padding: 10px;">
                            <canvas id="graficoTendencia12Meses"></canvas>
                        </div>
                        {% else %}
                        <div
                            style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">
                            No hay datos hist√≥ricos suficientes para mostrar la tendencia.
                        </div>
                        {% endif %}

                        <!-- Explicaci√≥n del gr√°fico -->
                        <div
                            style="margin-top: 20px; padding: 15px; background: #e6f7ff; border-left: 4px solid #1890ff; border-radius: 4px; font-size: 13px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #0050b3;">¬øQu√© muestra?</div>
                            <div style="color: #333; line-height: 1.6;">
                                <strong>Evoluci√≥n mensual</strong> de ventas vs metas para identificar patrones,
                                estacionalidad y cumplimiento sostenido.
                                Las √°reas sombreadas indican per√≠odos de sobre-cumplimiento (verde) o bajo-cumplimiento
                                (rojo) de metas.<br>
                                <span style="color:#1890ff; font-weight:500;">Este gr√°fico SIEMPRE muestra los √∫ltimos 12 meses, sin importar el mes seleccionado arriba.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- An√°lisis RFM (Segmentaci√≥n de Clientes) -->
                <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
                    <div class="tabla-header">
                        <h3>üéØ An√°lisis RFM - Segmentaci√≥n de Clientes</h3>
                    </div>

                    <!-- Grid de 2 columnas -->
                    <div
                        style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; margin-top: 20px; overflow: hidden;">
                        <!-- Columna 1: Distribuci√≥n de segmentos -->
                        <div class="grafico-container" style="margin: 0; overflow: hidden;">
                            <div class="tabla-header" style="margin-bottom: 15px;">
                                <h4 style="margin: 0; font-size: 16px;">Distribuci√≥n por Segmento</h4>
                            </div>
                            {% if segmentos_rfm %}
                            <div style="position: relative; height: 300px; width: 100%;">
                                <canvas id="graficoSegmentosRFM"
                                    style="width: 100%; height: 100%; display: block;"></canvas>
                            </div>

                            <!-- Leyenda de segmentos -->
                            <div
                                style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Definici√≥n de
                                    Segmentos:</div>
                                <div style="line-height: 1.8;">
                                    <div><span style="color: #52c41a;">‚óè</span> <strong>Campeones:</strong> Compran
                                        frecuente y recientemente, alto valor</div>
                                    <div><span style="color: #73d13d;">‚óè</span> <strong>Leales:</strong> Compran
                                        regularmente, buen valor</div>
                                    <div><span style="color: #95de64;">‚óè</span> <strong>Potenciales:</strong> Compras
                                        recientes, pueden crecer</div>
                                    <div><span style="color: #1890ff;">‚óè</span> <strong>Nuevos:</strong> Compraron
                                        recientemente por primera vez</div>
                                    <div><span style="color: #faad14;">‚óè</span> <strong>En Riesgo:</strong> Buenos
                                        clientes que no compran hace tiempo</div>
                                    <div><span style="color: #ff7a45;">‚óè</span> <strong>Hibernando:</strong> Bajo valor,
                                        no compran hace tiempo</div>
                                    <div><span style="color: #ff4d4f;">‚óè</span> <strong>Perdidos:</strong> Mucho tiempo
                                        sin comprar</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Columna 2: Top clientes -->
                        <div class="grafico-container" style="margin: 0; overflow: hidden;">
                            <div class="tabla-header" style="margin-bottom: 15px;">
                                <h4 style="margin: 0; font-size: 16px;">Top 20 Clientes por Valor</h4>
                            </div>
                            <div style="overflow-y: auto; overflow-x: hidden; max-height: 500px;">
                                <table class="tabla-avance" style="font-size: 12px; table-layout: fixed; width: 100%;">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">#</th>
                                            <th style="width: 35%;">Cliente</th>
                                            <th style="width: 15%;">Segmento</th>
                                            <th style="width: 12%;">Recency</th>
                                            <th style="width: 12%;">Frequency</th>
                                            <th style="width: 21%;">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cliente in clientes_rfm[:20] %}
                                        <tr>
                                            <td style="text-align: center;">{{ loop.index }}</td>
                                            <td style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                                title="{{ cliente.cliente }}">{{ cliente.cliente }}</td>
                                            <td style="text-align: center;">
                                                <span style="
                                        padding: 4px 8px;
                                        border-radius: 12px;
                                        font-size: 11px;
                                        font-weight: 600;
                                        background: {{ cliente.color }}22;
                                        color: {{ cliente.color }};
                                    ">
                                                    {{ cliente.categoria }}
                                                </span>
                                            </td>
                                            <td style="text-align: center;">{{ cliente.recency }} d√≠as</td>
                                            <td style="text-align: center;">{{ cliente.frequency }}</td>
                                            <td style="text-align: right; font-weight: 600;">S/ {{
                                                "{:,.0f}".format(cliente.monetary) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Insight -->
                            <div
                                style="margin-top: 15px; padding: 12px; background: #fff7e6; border-left: 4px solid #faad14; border-radius: 4px; font-size: 12px;">
                                <div style="font-weight: 600; margin-bottom: 6px; color: #d48806;">üí° Acci√≥n
                                    Recomendada:</div>
                                <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                                    <li><strong>Campeones:</strong> Programa de fidelizaci√≥n VIP</li>
                                    <li><strong>En Riesgo:</strong> Campa√±a de reactivaci√≥n urgente</li>
                                    <li><strong>Potenciales:</strong> Cross-selling y up-selling</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clientes en Riesgo -->
                <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
                    <div class="tabla-header">
                        <h3>‚ö†Ô∏è Clientes de Alto Valor en Riesgo</h3>
                    </div>

                    <div style="margin-top: 20px; overflow: hidden;">
                        {% if clientes_riesgo and clientes_riesgo|length > 0 %}
                        <div
                            style="overflow-x: auto; overflow-y: hidden; max-height: 600px; -webkit-overflow-scrolling: touch;">
                            <table class="tabla-avance"
                                style="font-size: 12px; table-layout: fixed; width: 100%; min-width: 800px;">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 30%;">Cliente</th>
                                        <th style="width: 15%;">Nivel Riesgo</th>
                                        <th style="width: 15%;">D√≠as sin Compra</th>
                                        <th style="width: 10%;">Frecuencia</th>
                                        <th style="width: 15%;">Valor Hist√≥rico</th>
                                        <th style="width: 10%;">Segmento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cliente in clientes_riesgo %}
                                    <tr>
                                        <td style="text-align: center;">{{ loop.index }}</td>
                                        <td style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                            title="{{ cliente.cliente }}">{{ cliente.cliente }}</td>
                                        <td style="text-align: center;">
                                            <span style="
                                    padding: 4px 10px;
                                    border-radius: 12px;
                                    font-size: 11px;
                                    font-weight: 700;
                                    background: {{ cliente.color }}22;
                                    color: {{ cliente.color }};
                                ">
                                                {{ cliente.nivel_riesgo }}
                                            </span>
                                        </td>
                                        <td style="text-align: center; font-weight: 600; color: {{ cliente.color }};">
                                            {{ cliente.dias_sin_compra }} d√≠as
                                        </td>
                                        <td style="text-align: center;">{{ cliente.frecuencia }} pedidos</td>
                                        <td style="text-align: right; font-weight: 600;">S/ {{
                                            "{:,.0f}".format(cliente.valor_historico) }}</td>
                                        <td style="text-align: center; font-size: 11px;">{{ cliente.categoria_rfm }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Estrategia de acci√≥n -->
                        <div
                            style="margin-top: 20px; padding: 15px; background: #fff1f0; border-left: 4px solid #ff4d4f; border-radius: 4px; font-size: 13px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #cf1322;">üö® Estrategia de
                                Retenci√≥n Urgente:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #ff4d4f; margin-bottom: 5px;">Nivel Alto (90+
                                        d√≠as):</div>
                                    <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                                        <li>Contacto directo del Key Account Manager</li>
                                        <li>Descuento especial de reactivaci√≥n (10-15%)</li>
                                        <li>Entrevista para identificar causas de abandono</li>
                                    </ul>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #faad14; margin-bottom: 5px;">Nivel Medio
                                        (60-90 d√≠as):</div>
                                    <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                                        <li>Email personalizado con recomendaciones</li>
                                        <li>Cup√≥n de descuento en pr√≥xima compra</li>
                                        <li>Llamada de seguimiento comercial</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div
                            style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px; color: #52c41a;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-size: 18px; font-weight: 600;">¬°Excelente! No hay clientes de alto valor en
                                riesgo</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">Todos los clientes importantes
                                est√°n activos</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- üî• HEATMAP DE ACTIVIDAD DE VENTAS -->
                <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
                    <h3 style="margin-bottom: 20px;">
                        <span style="font-size: 22px;">üî•</span>
                        Heatmap de Actividad de Ventas
                    </h3>

                    <div
                        style="background: #fff9e6; padding: 12px 15px; border-left: 4px solid #faad14; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
                        <div style="font-weight: 600; margin-bottom: 6px; color: #d48806;">üìä ¬øQu√© muestra?</div>
                        <div style="color: #666; line-height: 1.6;">
                            Mapa de calor que identifica <strong>d√≠as y semanas con mayor actividad de ventas</strong>.
                            Los colores m√°s intensos indican mayor volumen de ventas.
                            <strong>Acci√≥n:</strong> Planificar promociones en per√≠odos de baja actividad para
                            equilibrar flujo de trabajo.
                        </div>
                    </div>

                    <div style="position: relative; min-height: 450px; width: 100%;">
                        <div id="graficoHeatmapVentas"
                            style="position: relative; height: 420px; width: 100%; padding: 10px;"></div>
                    </div>
                    <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div
                            style="padding: 15px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border-radius: 8px;">
                            <div style="font-size: 11px; color: #0050b3; font-weight: 600; margin-bottom: 5px;">üí°
                                OPTIMIZACI√ìN DE RECURSOS</div>
                            <div style="font-size: 13px; color: #333; line-height: 1.5;">
                                Asignar m√°s personal comercial en d√≠as/semanas de alta demanda identificados en el
                                mapa
                            </div>
                        </div>
                        <div
                            style="padding: 15px; background: linear-gradient(135deg, #fff0f6 0%, #ffd6e7 100%); border-radius: 8px;">
                            <div style="font-size: 11px; color: #c41d7f; font-weight: 600; margin-bottom: 5px;">üéØ
                                ESTRATEGIA COMERCIAL</div>
                            <div style="font-size: 13px; color: #333; line-height: 1.5;">
                                Lanzar campa√±as promocionales en d√≠as de baja actividad para incrementar ventas
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üó∫Ô∏è PANEL GEOGR√ÅFICO DE AN√ÅLISIS COMERCIAL -->
                <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
                    <h3 style="margin-bottom: 20px;">
                        <span style="font-size: 22px;">üó∫Ô∏è</span>
                        An√°lisis Geogr√°fico de Penetraci√≥n Comercial
                    </h3>

                    <!-- Filtros para el mapa -->
                    <div class="map-filters"
                        style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; align-items: flex-end;">
                        <div>
                            <label for="mapa-linea-comercial"
                                style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">L√≠nea
                                Comercial</label>
                            <select id="mapa-linea-comercial"
                                style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="">Todas</option>
                                {% if filtros_mapa and filtros_mapa.lineas_comerciales %}
                                {% for linea in filtros_mapa.lineas_comerciales %}
                                <option value="{{ linea.id }}">{{ linea.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div>
                            <label for="mapa-grupo"
                                style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">Grupo</label>
                            <select id="mapa-grupo"
                                style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="">Todos</option>
                                {% if filtros_mapa and filtros_mapa.grupos %}
                                {% for grupo in filtros_mapa.grupos %}
                                <option value="{{ grupo.id }}">{{ grupo.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div>
                            <label for="mapa-zona"
                                style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">Zona</label>
                            <select id="mapa-zona"
                                style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="">Todas</option>
                                {% if filtros_mapa and filtros_mapa.zonas %}
                                {% for zona in filtros_mapa.zonas %}
                                <option value="{{ zona.id }}">{{ zona.name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div>
                            <button id="mapa-aplicar-filtros"
                                style="padding: 6px 12px; border: none; background-color: #875A7B; color: white; border-radius: 4px; cursor: pointer;">Aplicar</button>
                        </div>
                    </div>

                    <div
                        style="background: #e6f7ff; padding: 12px 15px; border-left: 4px solid #1890ff; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
                        <div style="font-weight: 600; margin-bottom: 6px; color: #0050b3;">üìä Inteligencia de Mercado
                        </div>
                        <div style="color: #666; line-height: 1.6;">
                            Visualizaci√≥n de ventas por departamento para identificar √°reas de <strong>alta
                                penetraci√≥n</strong> y <strong>oportunidades de expansi√≥n ("zonas blancas")</strong>.
                            Utilice el sem√°foro para priorizar acciones t√°cticas por regi√≥n.
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 30px;">
                        <!-- Mapa -->
                        <div style="position: relative; height: 500px; width: 100%;">
                            <div id="graficoMapaGeografico" style="width: 100%; height: 100%;"></div>
                        </div>

                        <!-- Leyenda de Sem√°foro -->
                        <div id="mapa-leyenda-semaforo"
                            style="background: white; border: 1px solid #e8e8e8; border-radius: 8px; padding: 20px; height: fit-content;">
                            <h4
                                style="margin: 0 0 15px 0; font-size: 16px; color: #1a1a1a; display: flex; align-items: center; gap: 8px;">
                                <span>üö¶</span>
                                <span>Sem√°foro de Penetraci√≥n</span>
                            </h4>

                            <!-- Categor√≠a Alta (Verde) -->
                            <div
                                style="margin-bottom: 12px; padding: 10px; background: #f6ffed; border-left: 4px solid #52c41a; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <div style="width: 14px; height: 14px; background: #52c41a; border-radius: 50%;">
                                    </div>
                                    <strong style="color: #389e0d; font-size: 13px;">Alta Penetraci√≥n</strong>
                                </div>
                                <div style="font-size: 11px; color: #333;">
                                    <strong>Acci√≥n:</strong> Fidelizaci√≥n VIP y productos premium.
                                </div>
                            </div>

                            <!-- Categor√≠a Media (Amarillo) -->
                            <div
                                style="margin-bottom: 12px; padding: 10px; background: #fffbe6; border-left: 4px solid #faad14; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <div style="width: 14px; height: 14px; background: #faad14; border-radius: 50%;">
                                    </div>
                                    <strong style="color: #d48806; font-size: 13px;">Media Penetraci√≥n</strong>
                                </div>
                                <div style="font-size: 11px; color: #333;">
                                    <strong>Acci√≥n:</strong> Incrementar visitas y marketing dirigido.
                                </div>
                            </div>

                            <!-- Categor√≠a Baja (Rojo) -->
                            <div
                                style="margin-bottom: 15px; padding: 10px; background: #fff1f0; border-left: 4px solid #ff4d4f; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <div style="width: 14px; height: 14px; background: #ff4d4f; border-radius: 50%;">
                                    </div>
                                    <strong style="color: #cf1322; font-size: 13px;">Baja Penetraci√≥n</strong>
                                </div>
                                <div style="font-size: 11px; color: #333;">
                                    <strong>Acci√≥n:</strong> Campa√±a agresiva y asignaci√≥n dedicada.
                                </div>
                            </div>

                            <!-- Resumen Estad√≠stico -->
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e8e8e8;">
                                <div id="mapa-resumen-categorias"
                                    style="font-size: 12px; color: #666; display: flex; flex-direction: column; gap: 5px;">
                                    <div>üü¢ Alta: <span id="count-alta" style="font-weight: 700;">-</span></div>
                                    <div>üü° Media: <span id="count-media" style="font-weight: 700;">-</span></div>
                                    <div>üî¥ Baja: <span id="count-baja" style="font-weight: 700;">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Estrat√©gicos -->
                    <div
                        style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                        <div
                            style="padding: 15px; background: linear-gradient(135deg, #e6fffb 0%, #b5f5ec 100%); border-radius: 8px;">
                            <div style="font-size: 11px; color: #006d75; font-weight: 600; margin-bottom: 5px;">üó∫Ô∏è
                                EXPANSI√ìN</div>
                            <div style="font-size: 12px; color: #333;">Identificar "zonas blancas" para capturar mercado
                                potencial sin explotar.</div>
                        </div>
                        <div
                            style="padding: 15px; background: linear-gradient(135deg, #fff7e6 0%, #ffd591 100%); border-radius: 8px;">
                            <div style="font-size: 11px; color: #d46b08; font-weight: 600; margin-bottom: 5px;">üöö
                                LOG√çSTICA</div>
                            <div style="font-size: 12px; color: #333;">Optimizar rutas comerciales seg√∫n concentraci√≥n
                                de clientes.</div>
                        </div>
                        <div
                            style="padding: 15px; background: linear-gradient(135deg, #f9f0ff 0%, #d3adf7 100%); border-radius: 8px;">
                            <div style="font-size: 11px; color: #531dab; font-weight: 600; margin-bottom: 5px;">üéØ
                                MARKETING</div>
                            <div style="font-size: 12px; color: #333;">Lanzar campa√±as geolocalizadas seg√∫n perfil
                                regional.</div>
                        </div>
                    </div>

                    <!-- Tabla de Detalle -->
                    <div style="margin-top: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #333;">üìã Detalle de
                            Ventas por Departamento</h4>
                        <div
                            style="max-height: 350px; overflow-y: auto; border: 1px solid #e8e8e8; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead style="position: sticky; top: 0; background: #fafafa; z-index: 1;">
                                    <tr>
                                        <th
                                            style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #e8e8e8;">
                                            Departamento</th>
                                        <th
                                            style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #e8e8e8;">
                                            Ventas (S/)</th>
                                        <th
                                            style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #e8e8e8;">
                                            Clientes</th>
                                        <th
                                            style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #e8e8e8;">
                                            Participaci√≥n</th>
                                        <th
                                            style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #e8e8e8;">
                                            Ticket Prom.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if datos_geograficos %}
                                    {% for region in datos_geograficos %}
                                    <tr
                                        style="border-bottom: 1px solid #f0f0f0; {% if loop.index <= 3 %}background: #f6ffed;{% endif %}">
                                        <td style="padding: 10px;">
                                            {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index ==
                                            3 %}ü•â{% else %}üìç{% endif %}
                                            {{ region.region }}
                                        </td>
                                        <td style="padding: 10px; text-align: right; font-weight: 600;">S/ {{
                                            "{:,.0f}".format(region.ventas) }}</td>
                                        <td style="padding: 10px; text-align: center;">{{ region.clientes }}</td>
                                        <td style="padding: 10px; text-align: right;">
                                            <div
                                                style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                                <span style="font-weight: 600; color: #52c41a;">{{
                                                    "%.1f"|format(region.participacion) }}%</span>
                                            </div>
                                        </td>
                                        <td style="padding: 10px; text-align: right; color: #666;">S/ {{
                                            "{:,.0f}".format(region.ticket_promedio) }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="5" style="padding: 20px; text-align: center; color: #999;">No hay
                                            datos geogr√°ficos detallados.</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- 
    GR√ÅFICOS DESACTIVADOS TEMPORALMENTE
    - Venta por tipo de Producto (Donut)
    - Top 7 Productos M√°s Vendidos
    - Venta por L√≠nea Comercial (Barras)
    - Ventas por Clasificaci√≥n Comercial
    - An√°lisis Jer√°rquico de Ventas
    - Venta por Clasificaci√≥n Farmacol√≥gica
    
    Para reactivarlos, descomenta los bloques correspondientes.
    -->
            </div>

            <style>
                /* Importar fuente Poppins para un look m√°s Odoo */
                @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

                :root {
                    --odoo-primary: #875A7B;
                    --odoo-primary-dark: #6B4563;
                }

                /* === ESTILOS DEL DASHBOARD === */
                body {
                    margin: 0;
                    padding: 20px;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background-color: #f5f7fa;
                    color: #2c3e50;
                }

                /* Header estilo Odoo */
                .dashboard-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background: linear-gradient(135deg, var(--odoo-primary) 0%, var(--odoo-primary-dark) 100%);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(135, 90, 123, 0.3);
                    margin-bottom: 25px;
                    font-family: 'Poppins', sans-serif;
                }

                /* Estilo para el enlace en la tabla */
                .tabla-avance td a {
                    text-decoration: none;
                    color: var(--odoo-primary);
                    font-weight: 600;
                }

                .header-left {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }

                .header-info {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 2px;
                }

                .header-info h1 {
                    margin: 0;
                    font-size: 24px;
                    font-weight: 700;
                    color: white;
                }

                .header-username {
                    font-size: 14px;
                    font-weight: 400;
                    color: rgba(255, 255, 255, 0.8);
                    padding-left: 2px;
                }

                /* Calendario central */
                .calendario-dia {
                    display: flex;
                    flex-direction: row;
                    align-items: center;
                    background: #3498db;
                    border-radius: 8px;
                    padding: 8px 12px;
                    color: white;
                    min-width: 60px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                    gap: 8px;
                }

                .dia-numero {
                    font-size: 24px;
                    font-weight: bold;
                    line-height: 1;
                }

                .dia-texto {
                    font-size: 10px;
                    font-weight: 500;
                    text-transform: uppercase;
                }



                .header-nav {
                    display: flex;
                    gap: 15px;
                    align-items: center;
                }

                #mes-selector {
                    padding: 8px 12px;
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 6px;
                    font-size: 14px;
                    background-color: rgba(255, 255, 255, 0.1);
                    color: white;
                    font-family: 'Poppins', sans-serif;
                }

                #mes-selector option {
                    background-color: #333;
                    color: white;
                }

                .btn-nav,
                .btn-salir,
                .btn-nav:visited,
                .btn-salir:visited {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 16px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 14px;
                    text-decoration: none;
                    transition: all 0.2s ease;
                }

                .btn-nav {
                    background-color: rgba(255, 255, 255, 0.15);
                    color: white;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }

                .btn-nav:hover {
                    background-color: rgba(255, 255, 255, 0.25);
                    transform: translateY(-1px);
                }

                .btn-salir {
                    background: #e74c3c;
                    color: white;
                }

                .btn-salir:hover {
                    background-color: #c0392b;
                    transform: translateY(-1px);
                }

                /* Dashboard Container */
                .dashboard-container {
                    display: flex;
                    flex-direction: column;
                    gap: 25px;
                }

                /* KPIs Row */
                .kpi-row {
                    display: grid;
                    grid-template-columns: repeat(6, 1fr);
                    /* Ajustado a 6 columnas */
                    gap: 15px;
                }

                .kpi-card {
                    background: white;
                    padding: 5px 15px;
                    /* Aumentado padding para m√°s espacio interno */
                    border-radius: 6px;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    text-align: center;
                    height: auto;
                    /* Altura autom√°tica basada en contenido */
                    min-height: 30px;
                    /* Aumentado de 20px a 30px */
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    /* Eliminar completamente cualquier animaci√≥n */
                    transition: none !important;
                    transform: none !important;
                    animation: none !important;
                    pointer-events: auto;
                }

                .kpi-card.kpi-meta {
                    border-left: 4px solid #8e44ad;
                }

                .kpi-card.kpi-avance {
                    border-left-color: #f39c12;
                    background: #fff3cd;
                }

                .kpi-card.kpi-vencimiento {
                    border-left-color: #3498db;
                    background: #d6eaf8;
                }

                /* Eliminar cualquier estado hover, focus, active */
                .kpi-card:hover,
                .kpi-card:focus,
                .kpi-card:active {
                    transition: none !important;
                    transform: none !important;
                    animation: none !important;
                }

                .kpi-label {
                    font-size: 12px;
                    /* Tama√±o normal - NO reducir */
                    color: #7f8c8d;
                    margin-bottom: 2px;
                    /* Peque√±o espacio entre label y valor */
                    font-weight: 600;
                    line-height: 1;
                }

                .kpi-value {
                    font-size: 18px;
                    /* Tama√±o normal - NO reducir */
                    font-weight: bold;
                    color: #2c3e50;
                    line-height: 1;
                }

                /* Avance Diario - Layout agrupado con IPN a la derecha */
                .avance-diario-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr 1fr;
                    /* 4 columnas iguales para layout 4x1 */
                    grid-template-rows: 1fr;
                    /* 1 sola fila */
                    gap: 15px;
                    margin-bottom: 15px;
                    /* Reducido de 20px a 15px */
                    max-width: 100%;
                    height: auto;
                }

                .avance-card-spacer {
                    /* Ya no es necesario - eliminado para layout 2x2 */
                    display: none;
                }

                .avance-card-placeholder {
                    /* Ya no es necesario - eliminado para layout 2x2 */
                    display: none;
                }

                /* Responsividad */
                @media (max-width: 1200px) {
                    .avance-diario-grid {
                        grid-template-columns: 1fr 1fr;
                        /* 2x2 en tablets */
                        grid-template-rows: 1fr 1fr;
                    }
                }

                @media (max-width: 768px) {
                    .avance-diario-grid {
                        grid-template-columns: 1fr;
                        /* 1 columna en m√≥viles */
                        grid-template-rows: repeat(4, auto);
                        /* 4 filas para m√≥viles */
                    }
                }

                .avance-card {
                    background: #ecf0f1;
                    padding: 10px 15px;
                    /* Aumentado padding para mejor proporci√≥n */
                    border-radius: 6px;
                    text-align: center;
                    height: auto;
                    /* Altura autom√°tica basada en contenido */
                    min-height: 70px;
                    /* Aumentado para mejor proporci√≥n en grid 2x2 */
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    /* Eliminar completamente cualquier animaci√≥n */
                    transition: none !important;
                    transform: none !important;
                    animation: none !important;
                }

                .avance-label {
                    font-size: 14px;
                    /* Mantener tama√±o original */
                    color: #7f8c8d;
                    margin-bottom: 2px;
                    /* Peque√±o espacio entre label y valor */
                    line-height: 1;
                }

                .avance-value {
                    font-size: 20px;
                    /* Mantener tama√±o original */
                    font-weight: bold;
                    color: #e67e22;
                    line-height: 1;
                }

                .avance-card.avance-requerido .avance-value {
                    color: #e74c3c;
                    /* Rojo para indicar urgencia */
                }

                /* Eliminar cualquier estado hover, focus, active en tarjetas de avance */
                .avance-card:hover,
                .avance-card:focus,
                .avance-card:active {
                    transition: none !important;
                    transform: none !important;
                    animation: none !important;
                }

                /* FILA 1: Tabla principal a ancho completo */
                .main-table-row {
                    /* No necesita grid, el contenedor de la tabla ocupar√° el 100% */
                }

                /* FILA 2: Dos tablas lado a lado 50-50 */
                .secondary-content-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    /* Dos columnas iguales (50% cada una) */
                    gap: 25px;
                    align-items: start;
                }

                /* Tabla Container (IZQUIERDA) */
                .tabla-container {
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                }

                .tabla-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin: 0 0 20px 0;
                }

                .tabla-header h3 {
                    margin: 0;
                    color: #2c3e50;
                    font-size: 18px;
                }

                .tabla-header-botones {
                    display: flex;
                    gap: 10px;
                }

                .btn-export-tabla {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 6px 12px;
                    background-color: #1D6F42;
                    /* Verde Excel */
                    color: white;
                    border-radius: 5px;
                    text-decoration: none;
                    font-size: 12px;
                    font-weight: 500;
                    transition: background-color 0.2s;
                }

                .btn-custom-action {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 6px 12px;
                    color: white;
                    border-radius: 5px;
                    text-decoration: none;
                    font-size: 12px;
                    font-weight: 500;
                    transition: background-color 0.2s;
                    background-color: var(--odoo-primary);
                }

                .btn-custom-action:hover {
                    background-color: var(--odoo-primary-dark);
                }

                .tabla-avance {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 12px;
                }

                .tabla-avance th {
                    background: var(--odoo-primary);
                    color: white;
                    padding: 12px 8px;
                    text-align: center;
                    font-weight: 600;
                }

                .tabla-avance td {
                    padding: 10px 8px;
                    border-bottom: 1px solid #ecf0f1;
                    text-align: center;
                }

                .tabla-avance .porcentaje {
                    font-weight: bold;
                    color: #e67e22;
                }

                .fila-total {
                    background: var(--odoo-primary) !important;
                    color: white !important;
                }

                .fila-total td {
                    color: white !important;
                    border-top: 2px solid var(--odoo-primary-dark);
                }

                /* Gr√°fico Ciclo de Vida (DERECHA) */
                .grafico-ciclo-vida {
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    text-align: center;
                }

                .grafico-ciclo-vida h3 {
                    margin: 0 0 20px 0;
                    color: #2c3e50;
                    font-size: 18px;
                }

                .donut-container {
                    position: relative;
                    height: 300px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                #grafico-donut {
                    max-width: 100%;
                    max-height: 100%;
                }

                /* Gr√°ficos Inferiores */
                .graficos-inferiores {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 25px;
                }

                .grafico-productos,
                .grafico-lineas {
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    /* SOLUCI√ìN: Evita que el contenido interno (canvas) cause desbordamiento */
                    overflow: hidden;
                }

                .grafico-productos h3,
                .grafico-lineas h3 {
                    margin: 0 0 20px 0;
                    color: #2c3e50;
                    font-size: 18px;
                    text-align: center;
                }

                .chart-container {
                    position: relative;
                    height: 300px;
                }

                /* Estilos para el nuevo gr√°fico ECharts */
                .grafico-extra-container {
                    margin-top: 25px;
                }

                .grafico-container {
                    background: white;
                    border-radius: 12px;
                    padding: 25px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                }

                .grafico-echarts {
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                }

                /* Estilos para el gauge de cobertura */
                .cobertura-gauge {
                    position: relative;
                }

                .gauge-circle {
                    position: relative;
                }

                .gauge-text {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                }

                .gauge-value {
                    font-size: 48px;
                    font-weight: 700;
                    margin-bottom: 5px;
                }

                .gauge-label {
                    font-size: 18px;
                    color: #666;
                    font-weight: 500;
                }

                /* Responsive */
                @media (max-width: 1200px) {
                    .kpi-row {
                        grid-template-columns: repeat(3, 1fr);
                    }

                    .secondary-content-row {
                        grid-template-columns: 1fr;
                    }
                }

                @media (max-width: 768px) {
                    .dashboard-header {
                        flex-direction: column;
                        gap: 20px;
                    }

                    .kpi-row {
                        grid-template-columns: repeat(2, 1fr);
                    }

                    .secondary-content-row {
                        grid-template-columns: 1fr;
                    }
                }

                /* Estilos para el mapa con sem√°foro */
                @media (max-width: 1200px) {
                    div[style*="grid-template-columns: 1fr 350px"] {
                        grid-template-columns: 1fr !important;
                    }

                    #mapa-leyenda-semaforo {
                        margin-top: 20px;
                    }
                }
            </style>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>

                // 1. Variables Globales de Datos (Inyectadas por Jinja2)
                // NOTA: tendencia y mapa son SIEMPRE ANUALES, no dependen del filtro de mes
                const globalData = {
                    lineas: {{ datos_lineas|default([])|tojson|safe }},
                    productos: {{ datos_productos|default([])|tojson|safe }},
                    cicloVida: {{ datos_ciclo_vida|default([])|tojson|safe }},
                    frecuencia: {{ datos_frecuencia_linea|default([])|tojson|safe }},
                    tendencia: {{ tendencia_12_meses|default([])|tojson|safe }}, // ANUAL
                    rfm: {{ segmentos_rfm|default({})|tojson|safe }},
                    heatmap: {{ heatmap_ventas|default([])|tojson|safe }},
                    mapa: {{ mapa_ventas_data|default([])|tojson|safe }},      // ANUAL
                    mes: '{{ mes_seleccionado }}',
                    dia: '{{ dia_actual }}'
                };

                // 2. Funciones de Gr√°ficos (ECharts & Chart.js)

                function crearGraficoFrecuenciaLinea() {
                    const chartDom = document.getElementById('graficoFrecuenciaLinea');
                    if (!chartDom || !globalData.frecuencia || globalData.frecuencia.length <= 1) return;
                    const myChart = echarts.init(chartDom);
                    const filtered = globalData.frecuencia.filter(d => !d.es_total).sort((a, b) => b.frecuencia - a.frecuencia);
                    myChart.setOption({
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: filtered.map(d => d.linea), axisLabel: { rotate: 45, interval: 0 } },
                        yAxis: { type: 'value' },
                        series: [{
                            type: 'bar', barWidth: '60%',
                            data: filtered.map(d => ({
                                value: d.frecuencia,
                                itemStyle: { color: d.frecuencia >= 2 ? '#52c41a' : (d.frecuencia >= 1 ? '#faad14' : '#ff4d4f') }
                            })),
                            label: { show: true, position: 'top', formatter: (p) => p.value.toFixed(2) }
                        }]
                    });
                }

                function crearGraficoTendencia12Meses() {
                    const canvas = document.getElementById('graficoTendencia12Meses');
                    if (!canvas || !globalData.tendencia || globalData.tendencia.length === 0) return;
                    const ctx = canvas.getContext('2d');

                    // C√°lculo de l√≠nea de tendencia (Regresi√≥n Lineal)
                    const data = globalData.tendencia.map(d => d.venta);
                    const n = data.length;
                    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                    for (let i = 0; i < n; i++) {
                        sumX += i;
                        sumY += data[i];
                        sumXY += i * data[i];
                        sumXX += i * i;
                    }
                    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                    const intercept = (sumY - slope * sumX) / n;
                    const trendData = data.map((_, i) => slope * i + intercept);

                    // Dataset inicial
                    const datasets = [
                        { label: 'Venta Real', data: data, borderColor: '#875A7B', backgroundColor: 'rgba(135, 90, 123, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Meta', data: globalData.tendencia.map(d => d.meta), borderColor: '#faad14', borderDash: [5, 5], fill: false, tension: 0.4 },
                        { label: 'Tendencia', data: trendData, borderColor: '#1890ff', borderDash: [3, 3], borderWidth: 2, fill: false, tension: 0, pointRadius: 0 }
                    ];

                    // Crear el gr√°fico y guardarlo en una variable global
                    window.chartTendencia = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: globalData.tendencia.map(d => d.mes_nombre),
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15
                                    }
                                }
                            }
                        }
                    });

                    // Agregar evento al checkbox de comparaci√≥n
                    const checkbox = document.getElementById('compararA√±oSiguiente');
                    if (checkbox) {
                        checkbox.addEventListener('change', function() {
                            if (this.checked) {
                                agregarComparacionA√±oSiguiente();
                            } else {
                                quitarComparacionA√±oSiguiente();
                            }
                        });
                    }
                }

                function agregarComparacionA√±oSiguiente() {
                    const a√±oActual = {{ a√±o_seleccionado }};
                    const a√±oSiguiente = a√±oActual + 1;
                    
                    // Mostrar loading
                    const canvas = document.getElementById('graficoTendencia12Meses');
                    if (canvas) {
                        canvas.style.opacity = '0.5';
                    }

                    // Fetch de datos del a√±o siguiente
                    fetch(`/render-data?a√±o=${a√±oSiguiente}&mes=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.tendencia && data.tendencia.length > 0) {
                                // Agregar dataset del a√±o siguiente
                                const ventasSiguiente = data.tendencia.map(d => d.venta);
                                window.chartTendencia.data.datasets.push({
                                    label: `Venta ${a√±oSiguiente}`,
                                    data: ventasSiguiente,
                                    borderColor: '#ff7300',
                                    backgroundColor: 'rgba(255, 115, 0, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2
                                });
                                window.chartTendencia.update();
                            } else {
                                alert(`No hay datos disponibles para ${a√±oSiguiente}`);
                                document.getElementById('compararA√±oSiguiente').checked = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar datos de comparaci√≥n:', error);
                            alert(`Error al cargar datos de ${a√±oSiguiente}`);
                            document.getElementById('compararA√±oSiguiente').checked = false;
                        })
                        .finally(() => {
                            if (canvas) {
                                canvas.style.opacity = '1';
                            }
                        });
                }

                function quitarComparacionA√±oSiguiente() {
                    // Remover el dataset del a√±o siguiente (siempre es el √∫ltimo agregado)
                    if (window.chartTendencia && window.chartTendencia.data.datasets.length > 3) {
                        window.chartTendencia.data.datasets.pop();
                        window.chartTendencia.update();
                    }
                }

                function crearGraficoSegmentosRFM() {
                    const canvas = document.getElementById('graficoSegmentosRFM');
                    if (!canvas || !globalData.rfm || Object.keys(globalData.rfm).length === 0) return;
                    const ctx = canvas.getContext('2d');
                    const orden = ['Campeones', 'Leales', 'Potenciales', 'Nuevos', 'En Riesgo', 'Hibernando', 'Perdidos', 'Otros'];
                    const labels = [], counts = [], colores = [];
                    orden.forEach(s => { if (globalData.rfm[s]) { labels.push(s); counts.push(globalData.rfm[s].count); colores.push(globalData.rfm[s].color); } });
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: counts, backgroundColor: colores, borderColor: '#fff', borderWidth: 3 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }

                function crearGraficoCicloVida() {
                    const chartDom = document.getElementById('grafico-donut');
                    if (!chartDom || !globalData.cicloVida || globalData.cicloVida.length === 0) return;
                    const myChart = echarts.init(chartDom);
                    myChart.setOption({
                        tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
                        legend: { top: '5%', left: 'center', type: 'scroll' },
                        series: [{
                            name: 'Ciclo de Vida', type: 'pie', radius: ['40%', '70%'], avoidLabelOverlap: false,
                            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                            data: globalData.cicloVida.map(item => ({ name: item.ciclo || 'Sin definir', value: item.venta || 0 }))
                        }]
                    });
                }

                function crearGraficoProductos() {
                    const canvas = document.getElementById('grafico-productos');
                    if (!canvas || !globalData.productos || globalData.productos.length === 0) return;
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: globalData.productos.map(p => p.nombre.length > 20 ? p.nombre.substring(0, 20) + '...' : p.nombre),
                            datasets: [{ label: 'Ventas', data: globalData.productos.map(p => p.venta), backgroundColor: '#3498db' }]
                        },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
                    });
                }

                function crearGraficoHeatmapVentas() {
                    const chartDom = document.getElementById('graficoHeatmapVentas');
                    if (!chartDom || !globalData.heatmap || globalData.heatmap.length === 0) return;
                    const myChart = echarts.init(chartDom);
                    const maxVal = Math.max(...globalData.heatmap.map(d => d.valor));
                    myChart.setOption({
                        tooltip: { position: 'top', formatter: (p) => `Venta: S/ ${p.data[2].toLocaleString()}` },
                        grid: { height: '70%', top: '10%' },
                        xAxis: { type: 'category', data: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'] },
                        yAxis: { type: 'category', data: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5'] },
                        visualMap: { min: 0, max: maxVal, calculable: true, orient: 'horizontal', left: 'center', bottom: '0%' },
                        series: [{ type: 'heatmap', data: globalData.heatmap.map(item => [item.dia, item.semana, item.valor]) }]
                    });
                }



                // --- 4. Funciones Auxiliares ---

                function normalizarNombre(str) {
                    if (!str) return '';
                    let nombre = str.replace(/\s*\(PE\)\s*/gi, '').trim();
                    nombre = nombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                    return nombre;
                }

                function crearGraficoCobertura() {
                    const circle = document.getElementById('coberturaCircle');
                    const labelEl = document.getElementById('coberturaLabel');
                    if (!circle || !labelEl) return;
                    const val = {{ kpis.cobertura_clientes|default (0)
                }};
                const radius = 130;
                const circumference = 2 * Math.PI * radius;
                circle.style.strokeDashoffset = circumference - (circumference * val / 100);
                labelEl.textContent = val >= 70 ? 'EXCELENTE' : (val >= 50 ? 'REGULAR' : 'BAJO');
                labelEl.style.color = val >= 70 ? '#52c41a' : (val >= 50 ? '#faad14' : '#ff4d4f');
                    }

                // --- 5. L√≥gica del Mapa Geogr√°fico ---

                let mapaGeograficoChart = null;
                let mapaDataGlobal = []; // Variable global para acceder desde tooltip

                async function fetchMapaData(filters = {}) {
                    try {
                        // Obtener a√±o y mes actual del globalData
                        const [a√±o, mes] = globalData.mes.split('-');
                        
                        const params = new URLSearchParams({
                            a√±o: filters.a√±o || a√±o,
                            mes: filters.mes || mes
                        });
                        
                        console.log('üó∫Ô∏è Cargando datos del mapa desde:', `/api/mapa-ventas?${params.toString()}`);
                        const response = await fetch(`/api/mapa-ventas?${params.toString()}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            console.log(`‚úÖ Mapa cargado: ${result.total_provincias} provincias, S/ ${result.total_ventas.toLocaleString('es-PE')} (Fuente: ${result.fuente})`);
                            return result.data;
                        } else {
                            console.error('‚ùå Error en respuesta API:', result.error);
                            return null;
                        }
                    } catch (error) {
                        console.error('‚ùå Error al cargar datos del mapa:', error);
                        return null;
                    }
                }

                function dibujarMapaGeografico(container, geoJson, data) {
                    if (!data || data.length === 0) {
                        console.warn('‚ö†Ô∏è No hay datos para el mapa');
                        return;
                    }

                    // Normalizar nombres en el GeoJSON a MAY√öSCULAS antes de registrar
                    geoJson.features.forEach(f => {
                        if (f.properties && f.properties.NOMBDEP) {
                            f.properties.name = f.properties.NOMBDEP.toUpperCase();
                            f.properties.NOMBDEP = f.properties.NOMBDEP.toUpperCase();
                        }
                    });

                    if (!mapaGeograficoChart) {
                        mapaGeograficoChart = echarts.init(container);
                        echarts.registerMap('PERU', geoJson);
                        console.log('‚úÖ Mapa PERU registrado con nombres normalizados');
                    }

                    // Crear mapa de ventas con datos de la API
                    const ventasMap = new Map();
                    const clientesMap = new Map();
                    const ticketMap = new Map();
                    
                    data.forEach(item => {
                        const name = (item.name || '').toUpperCase();
                        if (name) {
                            ventasMap.set(name, item.value || 0);
                            clientesMap.set(name, item.clientes || 0);
                            ticketMap.set(name, item.ticket_promedio || 0);
                        }
                    });

                    // Extraer nombres del GeoJSON para comparaci√≥n
                    const nombresGeo = geoJson.features.map(f => (f.properties.NOMBDEP || '').toUpperCase());
                    
                    // Mapear datos a features del GeoJSON - USAR MAY√öSCULAS CONSISTENTEMENTE
                    const mappedData = geoJson.features.map(f => {
                        const nombreGeo = (f.properties.NOMBDEP || '').toUpperCase();
                        const ventas = ventasMap.get(nombreGeo) || 0;
                        const clientes = clientesMap.get(nombreGeo) || 0;
                        const ticket = ticketMap.get(nombreGeo) || 0;
                        
                        return { 
                            name: nombreGeo,  // ‚ö†Ô∏è IMPORTANTE: Usar nombre en MAY√öSCULAS
                            value: ventas,
                            clientes: clientes,
                            ticket: ticket
                        };
                    });
                    
                    // Guardar en variable global para acceder desde tooltip
                    mapaDataGlobal = mappedData;

                    // Calcular valores para escala usando la variable global
                    const valoresConVentas = mapaDataGlobal.filter(d => d.value > 0).map(d => d.value);
                    const maxVal = Math.max(...valoresConVentas, 1);
                    const minVal = Math.min(...valoresConVentas, 0);

                    // Calcular percentiles para clasificaci√≥n m√°s inteligente
                    const sortedValues = [...valoresConVentas].sort((a, b) => a - b);
                    const percentil33 = sortedValues[Math.floor(sortedValues.length * 0.33)] || minVal;
                    const percentil66 = sortedValues[Math.floor(sortedValues.length * 0.66)] || (maxVal * 0.66);

                    // Contar provincias por categor√≠a
                    const counts = { alta: 0, media: 0, baja: 0 };
                    mapaDataGlobal.forEach(d => {
                        if (d.value >= percentil66) counts.alta++;
                        else if (d.value >= percentil33 && d.value < percentil66) counts.media++;
                        else if (d.value > 0) counts.baja++;
                    });

                    // Actualizar contador en la leyenda
                    const countAlta = document.getElementById('count-alta');
                    const countMedia = document.getElementById('count-media');
                    const countBaja = document.getElementById('count-baja');
                    
                    if (countAlta) countAlta.textContent = counts.alta;
                    if (countMedia) countMedia.textContent = counts.media;
                    if (countBaja) countBaja.textContent = counts.baja;

                    mapaGeograficoChart.setOption({
                        tooltip: {
                            trigger: 'item',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#ccc',
                            borderWidth: 1,
                            textStyle: {
                                color: '#333'
                            },
                            formatter: function (params) {
                                const nombreDpto = params.name;
                                const datosDpto = mapaDataGlobal.find(d => d.name === nombreDpto);
                                
                                if (!datosDpto || !datosDpto.value || datosDpto.value === 0) {
                                    return `<div style="padding: 10px;">
                                        <strong style="font-size: 14px;">${nombreDpto}</strong><br/>
                                        <span style="color: #999; margin-top: 5px; display: block;">Sin ventas registradas</span>
                                        <small style="color: #ccc; display: block; margin-top: 5px;">Debug: value=${datosDpto?.value}</small>
                                    </div>`;
                                }
                                
                                let categoria = 'Baja Penetraci√≥n';
                                let color = '#ff4d4f';
                                if (datosDpto.value >= percentil66) {
                                    categoria = 'Alta Penetraci√≥n';
                                    color = '#52c41a';
                                } else if (datosDpto.value >= percentil33) {
                                    categoria = 'Media Penetraci√≥n';
                                    color = '#faad14';
                                }
                                
                                const ventaFormato = datosDpto.value.toLocaleString('es-PE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                
                                const clientes = datosDpto.clientes || 0;
                                const ticket = datosDpto.ticket || 0;
                                const ticketFormato = ticket.toLocaleString('es-PE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                
                                return `<div style="padding: 12px; min-width: 240px;">
                                    <strong style="font-size: 15px; color: #1a1a1a;">${nombreDpto}</strong><br/>
                                    <div style="margin-top: 10px;">
                                        <div style="padding: 6px 10px; background: ${color}15; border-radius: 4px; margin-bottom: 8px;">
                                            <span style="color: ${color}; font-weight: bold; font-size: 13px;">‚óè ${categoria}</span>
                                        </div>
                                        <div style="line-height: 1.8; font-size: 13px;">
                                            <div style="margin-bottom: 4px;">
                                                <span style="color: #666;">üí∞ Ventas:</span> 
                                                <strong style="color: #1a1a1a;">S/ ${ventaFormato}</strong>
                                            </div>
                                            <div style="margin-bottom: 4px;">
                                                <span style="color: #666;">üë• Clientes:</span> 
                                                <strong style="color: #1a1a1a;">${clientes}</strong>
                                            </div>
                                            <div>
                                                <span style="color: #666;">üßæ Ticket Prom:</span> 
                                                <strong style="color: #1a1a1a;">S/ ${ticketFormato}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                            }
                        },
                        visualMap: {
                            min: 0,
                            max: maxVal,
                            left: 'left',
                            top: 'bottom',
                            type: 'piecewise',
                            splitNumber: 4,
                            pieces: [
                                { 
                                    min: percentil66, 
                                    label: `Alta (‚â•S/ ${(percentil66/1000).toFixed(0)}K)`, 
                                    color: '#52c41a' 
                                },
                                { 
                                    min: percentil33, 
                                    max: percentil66, 
                                    label: `Media (S/ ${(percentil33/1000).toFixed(0)}K-${(percentil66/1000).toFixed(0)}K)`, 
                                    color: '#faad14' 
                                },
                                { 
                                    min: 1, 
                                    max: percentil33, 
                                    label: `Baja (<S/ ${(percentil33/1000).toFixed(0)}K)`, 
                                    color: '#ff4d4f' 
                                },
                                { 
                                    value: 0, 
                                    label: 'Sin Ventas', 
                                    color: '#e0e0e0' 
                                }
                            ],
                            textStyle: {
                                color: '#333',
                                fontSize: 11
                            },
                            itemWidth: 20,
                            itemHeight: 14
                        },
                        series: [{ 
                            type: 'map', 
                            map: 'PERU', 
                            data: mapaDataGlobal,  // Usar variable global
                            roam: true,
                            scaleLimit: {
                                min: 0.8,
                                max: 3
                            },
                            label: {
                                show: false
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#fff',
                                    fontSize: 11,
                                    fontWeight: 'bold'
                                },
                                itemStyle: {
                                    areaColor: '#1890ff',
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }
                            },
                            select: {
                                label: {
                                    show: true,
                                    color: '#fff'
                                },
                                itemStyle: {
                                    areaColor: '#1890ff'
                                }
                            }
                        }]
                    });
                    
                    console.log('‚úÖ Mapa configurado con', mapaDataGlobal.length, 'departamentos');
                    window.addEventListener('resize', () => mapaGeograficoChart.resize());
                }

                async function inicializarMapaGeografico() {
                    const container = document.getElementById('graficoMapaGeografico');
                    if (!container) {
                        console.warn('‚ö†Ô∏è Contenedor del mapa no encontrado');
                        return;
                    }
                    
                    try {
                        console.log('üó∫Ô∏è Inicializando mapa geogr√°fico...');
                        
                        // Cargar GeoJSON de Per√∫
                        const response = await fetch('https://raw.githubusercontent.com/juaneladio/peru-geojson/master/peru_departamental_simple.geojson');
                        if (!response.ok) {
                            throw new Error(`Error al cargar GeoJSON: ${response.status}`);
                        }
                        const geoJson = await response.json();
                        console.log('‚úÖ GeoJSON de Per√∫ cargado');
                        
                        // Cargar datos del mapa desde la API
                        const mapaData = await fetchMapaData();
                        
                        if (mapaData && mapaData.length > 0) {
                            dibujarMapaGeografico(container, geoJson, mapaData);
                            console.log('‚úÖ Mapa geogr√°fico renderizado');
                        } else {
                            console.warn('‚ö†Ô∏è No hay datos para el mapa');
                        }
                        
                        // Event listener para filtros (deshabilitado por ahora)
                        const btnFiltros = document.getElementById('mapa-aplicar-filtros');
                        if (btnFiltros) {
                            btnFiltros.style.display = 'none'; // Ocultar filtros no implementados
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error al inicializar mapa:', error);
                        if (container) {
                            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">Error al cargar el mapa geogr√°fico</div>';
                        }
                    }
                }

                // --- 6. Inicializaci√≥n Centralizada ---

                document.addEventListener('DOMContentLoaded', () => {
                    console.log('üöÄ Inicializando Dashboard...');

                    const [year, month] = globalData.mes.split('-').map(Number);
                    const lastDay = new Date(year, month, 0).getDate();

                    if (typeof flatpickr !== 'undefined') {
                        flatpickr("#date-picker-trigger", {
                            defaultDate: `${globalData.mes}-${String(globalData.dia).padStart(2, '0')}`,
                            minDate: `${globalData.mes}-01`,
                            maxDate: `${globalData.mes}-${lastDay}`,
                            dateFormat: "Y-m-d",
                            onChange: (selectedDates) => {
                                if (selectedDates.length > 0) {
                                    const day = selectedDates[0].getDate();
                                    const url = new URL(window.location.href);
                                    url.searchParams.set('dia_fin', day);
                                    url.searchParams.set('mes', globalData.mes);
                                    window.location.href = url.toString();
                                }
                            }
                        });
                    }

                    [
                        crearGraficoFrecuenciaLinea,
                        crearGraficoTendencia12Meses,
                        crearGraficoSegmentosRFM,
                        crearGraficoCicloVida,
                        crearGraficoProductos,
                        crearGraficoHeatmapVentas,
                        crearGraficoCobertura,
                        inicializarMapaGeografico
                    ].forEach(fn => {
                        try { fn(); } catch (e) { console.error(`Error en ${fn.name}:`, e); }
                    });
                    console.log('‚úÖ Dashboard cargado satisfactoriamente.');
                });
            </script>

            {% endblock %}