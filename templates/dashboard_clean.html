{% extends 'base.html' %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Header con logo y t√≠tulo -->
<div class="dashboard-header">
    <div class="header-left">
        <div class="header-info">
            <!-- El logo se movi√≥ al CSS como fondo para un look m√°s limpio -->
            <h1>AVANCE DE VENTAS - {{ mes_nombre.upper() }}</h1>
            <span class="header-username">{{ session.user_name }}</span>
        </div>
    </div>
    
    <!-- Calendario central -->
    <a id="date-picker-trigger" class="calendario-dia" style="cursor: pointer; text-decoration: none;">
        <div class="dia-numero">{{ dia_actual }}</div>
        <div class="dia-texto">{{ mes_nombre.split()[0][:3] }}</div>
    </a>
    
    <div class="header-nav">
        <select id="mes-selector" onchange="cambiarMes(this.value)">
            {% for mes in meses_disponibles %}
            <option value="{{ mes.key }}" {% if mes.key == mes_seleccionado %}selected{% endif %}>
                {{ mes.nombre }}
            </option>
            {% endfor %}
        </select>
        {% if is_admin %}
            <a href="{{ url_for('sales') }}" class="btn-nav"><i class="bi bi-table"></i> Ventas</a>
        {% endif %}
        <a href="{{ url_for('logout') }}" class="btn-salir"><i class="bi bi-box-arrow-right"></i> Salir</a>
    </div>
</div>

<script>
// Funci√≥n para cambiar mes - Definida temprano para el selector
function cambiarMes(mesSeleccionado) {
    window.location.href = `?mes=${mesSeleccionado}`;
}
</script>

<!-- Dashboard principal -->
<div class="dashboard-container">
    <!-- Fila superior - KPIs principales -->
    <div class="kpi-row">
        <div class="kpi-card kpi-meta">
            <div class="kpi-label">Meta</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.meta_total) }}</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-label">Venta</div>  
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.venta_total) }}</div>
        </div>
        
        <div class="kpi-card kpi-avance">
            <div class="kpi-label">% Avance</div>
            <div class="kpi-value">{{ "{:.1f} %".format(kpis.porcentaje_avance) }}</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-label">Meta IPN</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.meta_ipn) }}</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-label">Venta IPN</div>
            <div class="kpi-value">{{ "{:,.0f}".format(kpis.venta_ipn) }}</div>
        </div>
        
        <div class="kpi-card kpi-avance">
            <div class="kpi-label">% Avance IPN</div>
            <div class="kpi-value">{{ "{:.1f} %".format(kpis.porcentaje_avance_ipn) }}</div>
        </div>
        <!-- Proyecci√≥n lineal y faltante movidas a Avance Diario (ver m√°s abajo) -->
    </div>
    
    <!-- FILA 1: TABLA PRINCIPAL COMENTADA - Los datos siguen carg√°ndose en el backend -->
    <!-- 
    <div class="main-table-row">
        <div class="tabla-container">
            <div class="tabla-header">
                <h3>Meta LC Total y Venta por L√≠nea Comercial Local</h3>
                {% if is_admin %}
                    <div class="tabla-header-botones">
                        <a href="{{ url_for('export_dashboard_details', mes=mes_seleccionado, dia_fin=dia_actual) }}" class="btn-export-tabla">
                            <i class="bi bi-file-earmark-excel"></i> Exportar Detalle
                        </a>
                    </div>
                {% endif %}
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th>L√≠nea Comercial</th>
                        <th>Meta</th>
                        <th>Venta</th>
                        <th>% Cump</th>
                        <th>% Total Vta.</th>
                        <th>Meta IPN</th>
                        <th>Venta IPN</th>
                        <th>% Cump IPN</th>
                        <th>Venc &lt;6 mss</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in datos_lineas_tabla %}
                    <tr>
                        <td>
                            <a href="{{ url_for('dashboard_linea', linea_nombre=linea.nombre, mes=mes_seleccionado) }}" title="Ver dashboard de vendedores para {{ linea.nombre }}">
                                {{ linea.nombre }}
                            </a>
                        </td>
                        <td>{{ "{:,.0f}".format(linea.meta) }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta) }}</td>
                        <td class="porcentaje">{{ "{:.1f}%".format(linea.porcentaje_total) }}</td>
                        <td class="porcentaje">{{ "%.1f%%"|format(linea.porcentaje_sobre_total) }}</td>
                        <td>{{ "{:,.0f}".format(linea.meta_pn) }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta_pn) }}</td>
                        <td class="porcentaje">{{ "{:.1f}%".format(linea.porcentaje_pn) }}</td>
                        <td><strong>{{ "{:,.0f}".format(linea.vencimiento_6_meses) }}</strong></td>
                    </tr>
                    {% endfor %}
                    <tr class="fila-total">
                        <td><strong>Total</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.meta_total) }}</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.venta_total) }}</strong></td>
                        <td class="porcentaje"><strong>{{ "{:.1f}%".format(kpis.porcentaje_avance) }}</strong></td>
                        <td class="porcentaje"><strong>100.0%</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.meta_ipn) }}</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.venta_ipn) }}</strong></td>
                        <td class="porcentaje"><strong>{{ "{:.1f}%".format(kpis.porcentaje_avance_ipn) }}</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.vencimiento_6_meses) }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    -->

    <!-- FILA 2: DOS TABLAS LADO A LADO -->
    <div class="secondary-content-row">
        <!-- Tabla de L√≠neas Comerciales (IZQUIERDA) -->
        {% if datos_lineas_tabla %}
        <div class="tabla-container tabla-ecommerce">
            <div class="tabla-header">
                <h3>Ventas por L√≠nea Comercial</h3>
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th style="width: 50%;">L√≠nea Comercial</th>
                        <th style="width: 25%;">s/ Facturado</th>
                        <th style="width: 25%;">% Total Vta.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in datos_lineas_tabla %}
                    <tr>
                        <td>{{ linea.nombre }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta) }}</td>
                        <td class="porcentaje">{{ "%.1f%%"|format(linea.porcentaje_sobre_total) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="fila-total">
                        <td><strong>Total</strong></td>
                        <td><strong>{{ "{:,.0f}".format(kpis.venta_total) }}</strong></td>
                        <td class="porcentaje"><strong>100.0%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Tabla de Clientes por L√≠nea Comercial (DERECHA) -->
        {% if datos_clientes_por_linea %}
        <div class="tabla-container tabla-ecommerce">
            <div class="tabla-header">
                <h3>An√°lisis de Clientes por L√≠nea Comercial</h3>
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th style="width: 40%;">L√≠nea Comercial</th>
                        <th style="width: 20%;">s/ Facturado</th>
                        <th style="width: 20%;">N¬∞ Clientes</th>
                        <th style="width: 20%;">Ticket/Cliente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in datos_clientes_por_linea %}
                    <tr>
                        <td>{{ linea.nombre }}</td>
                        <td>{{ "{:,.0f}".format(linea.venta) }}</td>
                        <td>{{ linea.num_clientes }}</td>
                        <td>{{ "{:,.0f}".format(linea.ticket_promedio) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    
    <!-- Gr√°fico de Cobertura de Clientes -->
    <div class="grafico-container" style="margin-top: 30px;">
        <div class="tabla-header">
            <h3>üìä Cobertura de Clientes</h3>
        </div>
        
        <!-- Grid de 2 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px;">
            <!-- Columna 1: Gauge de cobertura SVG mejorado -->
            <div class="grafico-container" style="margin: 0;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Indicador General</h4>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div class="cobertura-gauge" style="position: relative;">
                        <svg width="320" height="320" viewBox="0 0 320 320" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                            <!-- C√≠rculo de fondo con gradiente -->
                            <defs>
                                <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#f0f0f0;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:1" />
                                </linearGradient>
                                
                                <!-- Gradiente para el progreso -->
                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#ff4d4f;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#ff7a45;stop-opacity:1" />
                                    <stop offset="65%" style="stop-color:#faad14;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#52c41a;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            
                            <!-- C√≠rculo de fondo -->
                            <circle cx="160" cy="160" r="130" fill="none" stroke="url(#gaugeGradient)" stroke-width="28" opacity="0.3"/>
                            
                            <!-- Marcadores de objetivos con l√≠neas m√°s visibles -->
                            <!-- 50% -->
                            <line x1="160" y1="30" x2="160" y2="55" stroke="#ff4d4f" stroke-width="4" opacity="0.8"/>
                            <text x="160" y="20" text-anchor="middle" fill="#ff4d4f" font-size="13" font-weight="700">50%</text>
                            
                            <!-- 65% -->
                            <line x1="252" y1="66" x2="235" y2="83" stroke="#faad14" stroke-width="4" opacity="0.9"/>
                            <text x="270" y="65" text-anchor="middle" fill="#faad14" font-size="13" font-weight="700">65%</text>
                            
                            <!-- 70% -->
                            <line x1="278" y1="118" x2="258" y2="128" stroke="#52c41a" stroke-width="4" opacity="0.9"/>
                            <text x="298" y="122" text-anchor="middle" fill="#52c41a" font-size="13" font-weight="700">70%</text>
                            
                            <!-- C√≠rculo de progreso animado -->
                            <circle id="coberturaCircle" cx="160" cy="160" r="130" fill="none" 
                                    stroke-width="28" 
                                    stroke-dasharray="817" 
                                    stroke-dashoffset="817"
                                    stroke-linecap="round"
                                    transform="rotate(-90 160 160)"
                                    style="transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease;"/>
                            
                            <!-- C√≠rculo central decorativo -->
                            <circle cx="160" cy="160" r="100" fill="white" opacity="0.95" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));"/>
                        </svg>
                        
                        <!-- Texto centrado sobre el SVG -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 180px;">
                            <div id="coberturaValue" style="font-size: 48px; font-weight: 800; line-height: 1; margin-bottom: 8px; transition: color 0.3s ease;">
                                {{ kpis.cobertura_clientes|round(1) }}%
                            </div>
                            <div id="coberturaLabel" style="font-size: 16px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                                Cobertura
                            </div>
                        </div>
                    </div>
                    
                    <!-- Leyenda de objetivos debajo del gauge -->
                    <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 12px; width: 100%; max-width: 300px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #333; text-align: center;">Objetivos</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                            <div><span style="color: #ff4d4f;">‚óè</span> <50% Bajo</div>
                            <div><span style="color: #ff7a45;">‚óè</span> 50-65% Regular</div>
                            <div><span style="color: #faad14;">‚óè</span> 65-70% Meta</div>
                            <div><span style="color: #52c41a;">‚óè</span> 70%+ Excelente</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna 2: Tabla de cobertura por canal -->
            <div class="grafico-container" style="margin: 0;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Cobertura por Canal</h4>
                </div>
                <div style="overflow-y: auto; max-height: 400px;">
                    <table class="tabla-avance" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Canal</th>
                                <th style="width: 22%;">Cartera</th>
                                <th style="width: 22%;">Activos</th>
                                <th style="width: 21%;">Cobertura</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for canal in datos_cobertura_canal %}
                            <tr {% if canal.get('es_total') %}style="background: #f0f2f5; font-weight: 700; border-top: 2px solid #875A7B;"{% endif %}>
                                <td><strong>{{ canal.canal }}</strong></td>
                                <td style="text-align: center;">{{ canal.cartera }}</td>
                                <td style="text-align: center;">{{ canal.activos }}</td>
                                <td style="text-align: center;">
                                    <span style="
                                        font-weight: 700;
                                        font-size: 14px;
                                        color: {% if canal.cobertura >= 70 %}#52c41a{% elif canal.cobertura >= 65 %}#faad14{% elif canal.cobertura >= 50 %}#ff7a45{% else %}#ff4d4f{% endif %};
                                    ">
                                        {{ "{:.1f}".format(canal.cobertura) }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Leyenda de objetivos debajo de la tabla -->
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #333; text-align: center;">Objetivos</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                        <div><span style="color: #ff4d4f;">‚óè</span> <50% Bajo</div>
                        <div><span style="color: #ff7a45;">‚óè</span> 50-65% Regular</div>
                        <div><span style="color: #faad14;">‚óè</span> 65-70% Meta</div>
                        <div><span style="color: #52c41a;">‚óè</span> 70%+ Excelente</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f2f5; border-radius: 8px; color: #666; font-size: 14px;">
            <strong style="color: #875A7B;">{{ kpis.clientes_activos }}</strong> clientes activos de 
            <strong style="color: #875A7B;">{{ kpis.total_clientes_cartera }}</strong> en cartera del a√±o {{ fecha_actual.year }}
        </div>
    </div>
    
    <!-- Gr√°fico de Frecuencia de Compra -->
    <div class="grafico-container" style="margin-top: 30px;">
        <div class="tabla-header">
            <h3>üîÑ Frecuencia de Compra</h3>
        </div>
        
        <!-- Grid de 2 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px;">
            <!-- Columna 1: Gr√°fico de barras -->
            <div class="grafico-container" style="margin: 0;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Frecuencia por L√≠nea Comercial</h4>
                </div>
                {% if datos_frecuencia_linea and datos_frecuencia_linea|length > 1 %}
                <div id="graficoFrecuenciaLinea" style="width: 100%; height: 400px;"></div>
                {% else %}
                <div style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">
                    No hay datos suficientes para mostrar el gr√°fico.
                </div>
                {% endif %}
                
                <!-- Explicaci√≥n del KPI -->
                <div style="margin-top: 15px; padding: 12px; background: #e6f7ff; border-left: 4px solid #1890ff; border-radius: 4px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 6px; color: #0050b3;">¬øQu√© mide?</div>
                    <div style="color: #333; line-height: 1.5;">
                        La frecuencia refleja qu√© tan seguido cada cliente vuelve a requerir nuestros productos. 
                        Si est√° en 1, significa que compran solo 1 vez al mes; si sube a 2 o m√°s, este cliente vuelve y depende de nosotros.
                    </div>
                </div>
            </div>
            
            <!-- Columna 2: Tabla de frecuencia por l√≠nea -->
            <div class="grafico-container" style="margin: 0;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Detalle por L√≠nea</h4>
                </div>
                <div style="overflow-y: auto; max-height: 400px;">
                    <table class="tabla-avance" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="width: 35%;">L√≠nea Comercial</th>
                                <th style="width: 20%;">N¬∞ Clientes</th>
                                <th style="width: 20%;">Q Pedidos</th>
                                <th style="width: 25%;">Frecuencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for linea in datos_frecuencia_linea|default([]) %}
                            <tr {% if linea.get('es_total') %}style="background: #f0f2f5; font-weight: 700; border-top: 2px solid #875A7B;"{% endif %}>
                                <td><strong>{{ linea.linea }}</strong></td>
                                <td style="text-align: center;">{{ linea.clientes_activos }}</td>
                                <td style="text-align: center;">{{ linea.pedidos }}</td>
                                <td style="text-align: center;">
                                    <span style="
                                        font-weight: 700;
                                        font-size: 14px;
                                        color: {% if linea.frecuencia >= 2 %}#52c41a{% elif linea.frecuencia >= 1 %}#faad14{% else %}#ff4d4f{% endif %};
                                    ">
                                        {{ "{:.2f}".format(linea.frecuencia) }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999; padding: 20px;">
                                    No hay datos disponibles para este mes
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Objetivo vs Bench -->
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #333; text-align: center;">Objetivo vs Bench</div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 6px; font-size: 11px;">
                        <div><span style="color: #ff4d4f;">‚óè</span> <1 pedido/mes ‚Üí riesgo (cliente ocasional)</div>
                        <div><span style="color: #faad14;">‚óè</span> 1-2 pedidos/mes ‚Üí est√°ndar industria</div>
                        <div><span style="color: #52c41a;">‚óè</span> 2-3 pedidos/mes ‚Üí muy bueno (recurrencia saludable)</div>
                    </div>
                </div>
                
                <!-- Asegura -->
                <div style="margin-top: 15px; padding: 12px; background: #fff7e6; border-left: 4px solid #faad14; border-radius: 4px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 6px; color: #d48806;">Asegura:</div>
                    <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                        <li>Anticipar ingresos: clientes con frecuencia alta generan ventas m√°s predecibles</li>
                        <li>Medir fidelidad real: m√°s pedidos, m√°s confianza en nuestra marca</li>
                        <li>Identificar oportunidades: clientes de baja frecuencia son los que a√∫n pueden crecer</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tendencia Hist√≥rica de Ventas (12 meses) -->
    <div class="grafico-container" style="margin-top: 30px;">
        <div class="tabla-header">
            <h3>üìà Tendencia Hist√≥rica de Ventas (12 Meses)</h3>
        </div>
        
        <div style="margin-top: 20px; position: relative;">
            {% if tendencia_12_meses and tendencia_12_meses|length > 0 %}
<<<<<<< HEAD
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="graficoTendencia12Meses" style="width: 100%; height: 100%; display: block;"></canvas>
=======
            <div style="position: relative; height: 420px; width: 100%; padding: 10px;">
                <canvas id="graficoTendencia12Meses"></canvas>
>>>>>>> 8880ed7fe8e309d92ca2833d029c9f8d287e1631
            </div>
            {% else %}
            <div style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">
                No hay datos hist√≥ricos suficientes para mostrar la tendencia.
            </div>
            {% endif %}
            
            <!-- Explicaci√≥n del gr√°fico -->
            <div style="margin-top: 20px; padding: 15px; background: #e6f7ff; border-left: 4px solid #1890ff; border-radius: 4px; font-size: 13px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #0050b3;">¬øQu√© muestra?</div>
                <div style="color: #333; line-height: 1.6;">
                    <strong>Evoluci√≥n mensual</strong> de ventas vs metas para identificar patrones, estacionalidad y cumplimiento sostenido.
                    Las √°reas sombreadas indican per√≠odos de sobre-cumplimiento (verde) o bajo-cumplimiento (rojo) de metas.
                </div>
            </div>
        </div>
    </div>
    
    <!-- An√°lisis RFM (Segmentaci√≥n de Clientes) -->
    <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
        <div class="tabla-header">
            <h3>üéØ An√°lisis RFM - Segmentaci√≥n de Clientes</h3>
        </div>
        
        <!-- Grid de 2 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; margin-top: 20px; overflow: hidden;">
            <!-- Columna 1: Distribuci√≥n de segmentos -->
            <div class="grafico-container" style="margin: 0; overflow: hidden;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Distribuci√≥n por Segmento</h4>
                </div>
                {% if segmentos_rfm %}
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="graficoSegmentosRFM" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
                
                <!-- Leyenda de segmentos -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Definici√≥n de Segmentos:</div>
                    <div style="line-height: 1.8;">
                        <div><span style="color: #52c41a;">‚óè</span> <strong>Campeones:</strong> Compran frecuente y recientemente, alto valor</div>
                        <div><span style="color: #73d13d;">‚óè</span> <strong>Leales:</strong> Compran regularmente, buen valor</div>
                        <div><span style="color: #95de64;">‚óè</span> <strong>Potenciales:</strong> Compras recientes, pueden crecer</div>
                        <div><span style="color: #1890ff;">‚óè</span> <strong>Nuevos:</strong> Compraron recientemente por primera vez</div>
                        <div><span style="color: #faad14;">‚óè</span> <strong>En Riesgo:</strong> Buenos clientes que no compran hace tiempo</div>
                        <div><span style="color: #ff7a45;">‚óè</span> <strong>Hibernando:</strong> Bajo valor, no compran hace tiempo</div>
                        <div><span style="color: #ff4d4f;">‚óè</span> <strong>Perdidos:</strong> Mucho tiempo sin comprar</div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Columna 2: Top clientes -->
            <div class="grafico-container" style="margin: 0; overflow: hidden;">
                <div class="tabla-header" style="margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 16px;">Top 20 Clientes por Valor</h4>
                </div>
                <div style="overflow-y: auto; overflow-x: hidden; max-height: 500px;">
                    <table class="tabla-avance" style="font-size: 12px; table-layout: fixed; width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 35%;">Cliente</th>
                                <th style="width: 15%;">Segmento</th>
                                <th style="width: 12%;">Recency</th>
                                <th style="width: 12%;">Frequency</th>
                                <th style="width: 21%;">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente in clientes_rfm[:20] %}
                            <tr>
                                <td style="text-align: center;">{{ loop.index }}</td>
                                <td style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ cliente.cliente }}">{{ cliente.cliente }}</td>
                                <td style="text-align: center;">
                                    <span style="
                                        padding: 4px 8px;
                                        border-radius: 12px;
                                        font-size: 11px;
                                        font-weight: 600;
                                        background: {{ cliente.color }}22;
                                        color: {{ cliente.color }};
                                    ">
                                        {{ cliente.categoria }}
                                    </span>
                                </td>
                                <td style="text-align: center;">{{ cliente.recency }} d√≠as</td>
                                <td style="text-align: center;">{{ cliente.frequency }}</td>
                                <td style="text-align: right; font-weight: 600;">S/ {{ "{:,.0f}".format(cliente.monetary) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Insight -->
                <div style="margin-top: 15px; padding: 12px; background: #fff7e6; border-left: 4px solid #faad14; border-radius: 4px; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 6px; color: #d48806;">üí° Acci√≥n Recomendada:</div>
                    <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                        <li><strong>Campeones:</strong> Programa de fidelizaci√≥n VIP</li>
                        <li><strong>En Riesgo:</strong> Campa√±a de reactivaci√≥n urgente</li>
                        <li><strong>Potenciales:</strong> Cross-selling y up-selling</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clientes en Riesgo -->
    <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
        <div class="tabla-header">
            <h3>‚ö†Ô∏è Clientes de Alto Valor en Riesgo</h3>
        </div>
        
        <div style="margin-top: 20px; overflow: hidden;">
            {% if clientes_riesgo and clientes_riesgo|length > 0 %}
            <div style="overflow-x: auto; overflow-y: hidden; max-height: 600px; -webkit-overflow-scrolling: touch;">
                <table class="tabla-avance" style="font-size: 12px; table-layout: fixed; width: 100%; min-width: 800px;">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 30%;">Cliente</th>
                            <th style="width: 15%;">Nivel Riesgo</th>
                            <th style="width: 15%;">D√≠as sin Compra</th>
                            <th style="width: 10%;">Frecuencia</th>
                            <th style="width: 15%;">Valor Hist√≥rico</th>
                            <th style="width: 10%;">Segmento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in clientes_riesgo %}
                        <tr>
                            <td style="text-align: center;">{{ loop.index }}</td>
                            <td style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ cliente.cliente }}">{{ cliente.cliente }}</td>
                            <td style="text-align: center;">
                                <span style="
                                    padding: 4px 10px;
                                    border-radius: 12px;
                                    font-size: 11px;
                                    font-weight: 700;
                                    background: {{ cliente.color }}22;
                                    color: {{ cliente.color }};
                                ">
                                    {{ cliente.nivel_riesgo }}
                                </span>
                            </td>
                            <td style="text-align: center; font-weight: 600; color: {{ cliente.color }};">
                                {{ cliente.dias_sin_compra }} d√≠as
                            </td>
                            <td style="text-align: center;">{{ cliente.frecuencia }} pedidos</td>
                            <td style="text-align: right; font-weight: 600;">S/ {{ "{:,.0f}".format(cliente.valor_historico) }}</td>
                            <td style="text-align: center; font-size: 11px;">{{ cliente.categoria_rfm }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Estrategia de acci√≥n -->
            <div style="margin-top: 20px; padding: 15px; background: #fff1f0; border-left: 4px solid #ff4d4f; border-radius: 4px; font-size: 13px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #cf1322;">üö® Estrategia de Retenci√≥n Urgente:</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <div>
                        <div style="font-weight: 600; color: #ff4d4f; margin-bottom: 5px;">Nivel Alto (90+ d√≠as):</div>
                        <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                            <li>Contacto directo del Key Account Manager</li>
                            <li>Descuento especial de reactivaci√≥n (10-15%)</li>
                            <li>Entrevista para identificar causas de abandono</li>
                        </ul>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #faad14; margin-bottom: 5px;">Nivel Medio (60-90 d√≠as):</div>
                        <ul style="margin: 0; padding-left: 20px; color: #333; line-height: 1.6;">
                            <li>Email personalizado con recomendaciones</li>
                            <li>Cup√≥n de descuento en pr√≥xima compra</li>
                            <li>Llamada de seguimiento comercial</li>
                        </ul>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px; color: #52c41a;">
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                <div style="font-size: 18px; font-weight: 600;">¬°Excelente! No hay clientes de alto valor en riesgo</div>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">Todos los clientes importantes est√°n activos</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- üî• HEATMAP DE ACTIVIDAD DE VENTAS -->
    <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
        <h3 style="margin-bottom: 20px;">
            <span style="font-size: 22px;">üî•</span>
            Heatmap de Actividad de Ventas
        </h3>
        
        <div style="background: #fff9e6; padding: 12px 15px; border-left: 4px solid #faad14; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
            <div style="font-weight: 600; margin-bottom: 6px; color: #d48806;">üìä ¬øQu√© muestra?</div>
            <div style="color: #666; line-height: 1.6;">
                Mapa de calor que identifica <strong>d√≠as y semanas con mayor actividad de ventas</strong>. 
                Los colores m√°s intensos indican mayor volumen de ventas. 
                <strong>Acci√≥n:</strong> Planificar promociones en per√≠odos de baja actividad para equilibrar flujo de trabajo.
            </div>
        </div>
        
        <div style="position: relative; height: 350px; width: 100%;">
            <div id="graficoHeatmapVentas" style="width: 100%; height: 100%;"></div>
        </div>
        
        <!-- Insights autom√°ticos -->
        <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="padding: 15px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border-radius: 8px;">
                <div style="font-size: 11px; color: #0050b3; font-weight: 600; margin-bottom: 5px;">üí° OPTIMIZACI√ìN DE RECURSOS</div>
                <div style="font-size: 13px; color: #333; line-height: 1.5;">
                    Asignar m√°s personal comercial en d√≠as/semanas de alta demanda identificados en el mapa
                </div>
            </div>
            <div style="padding: 15px; background: linear-gradient(135deg, #fff0f6 0%, #ffd6e7 100%); border-radius: 8px;">
                <div style="font-size: 11px; color: #c41d7f; font-weight: 600; margin-bottom: 5px;">üéØ ESTRATEGIA COMERCIAL</div>
                <div style="font-size: 13px; color: #333; line-height: 1.5;">
                    Lanzar campa√±as promocionales en d√≠as de baja actividad para incrementar ventas
                </div>
            </div>
        </div>
    </div>

    <!-- üó∫Ô∏è MAPA GEOGR√ÅFICO DE PENETRACI√ìN -->
    <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
        <h3 style="margin-bottom: 20px;">
            <span style="font-size: 22px;">üó∫Ô∏è</span>
            Mapa Geogr√°fico de Penetraci√≥n
        </h3>
        
        <!-- Filtros para el mapa -->
        <div class="map-filters" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; align-items: flex-end;">
            <div>
                <label for="mapa-linea-comercial" style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">L√≠nea Comercial</label>
                <select id="mapa-linea-comercial" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="">Todas</option>
                    {# Asumiendo que pasas una variable `filtros_mapa` desde el backend #}
                    {% if filtros_mapa and filtros_mapa.lineas_comerciales %}
                        {% for linea in filtros_mapa.lineas_comerciales %}
                        <option value="{{ linea.id }}">{{ linea.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div>
                <label for="mapa-grupo" style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">Grupo</label>
                <select id="mapa-grupo" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="">Todos</option>
                    {% if filtros_mapa and filtros_mapa.grupos %}
                        {% for grupo in filtros_mapa.grupos %}
                        <option value="{{ grupo.id }}">{{ grupo.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div>
                <label for="mapa-zona" style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">Zona</label>
                <select id="mapa-zona" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="">Todas</option>
                    {% if filtros_mapa and filtros_mapa.zonas %}
                        {% for zona in filtros_mapa.zonas %}
                        <option value="{{ zona.id }}">{{ zona.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div>
                <button id="mapa-aplicar-filtros" style="padding: 6px 12px; border: none; background-color: #875A7B; color: white; border-radius: 4px; cursor: pointer;">Aplicar</button>
            </div>
        </div>

        <div style="background: #e6f7ff; padding: 12px 15px; border-left: 4px solid #1890ff; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
            <div style="font-weight: 600; margin-bottom: 6px; color: #0050b3;">üìä ¬øQu√© muestra?</div>
            <div style="color: #666; line-height: 1.6;">
                Ventas por departamento (basado en state_id de la ciudad del socio) para identificar zonas de alta penetraci√≥n vs. oportunidades de mercado.
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 20px;">
            <!-- Mapa -->
            <div style="position: relative; height: 500px; width: 100%;">
                {% if mapa_ventas_data and mapa_ventas_data|length > 0 %}
                <div id="graficoMapaGeografico" style="width: 100%; height: 100%;"></div>
                {% else %}
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">No hay datos geogr√°ficos para mostrar en el mapa.</div>
                {% endif %}
            </div>
            
            <!-- Leyenda de Sem√°foro y Acciones Recomendadas -->
            <div id="mapa-leyenda-semaforo" style="background: white; border: 1px solid #e8e8e8; border-radius: 8px; padding: 20px; height: fit-content;">
                <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #1a1a1a; display: flex; align-items: center; gap: 8px;">
                    <span>üö¶</span>
                    <span>Sem√°foro de Penetraci√≥n</span>
                </h4>
                
                <!-- Categor√≠a Alta (Verde) -->
                <div style="margin-bottom: 20px; padding: 12px; background: #f6ffed; border-left: 4px solid #52c41a; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="width: 20px; height: 20px; background: #52c41a; border-radius: 50%;"></div>
                        <strong style="color: #389e0d; font-size: 14px;">Alta Penetraci√≥n</strong>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        Provincias con ventas en el <strong>top 33%</strong>
                    </div>
                    <div style="font-size: 12px; color: #333;">
                        <strong>üí° Acci√≥n:</strong> Mantener presencia, profundizar relaciones con clientes existentes, ofrecer productos premium, programas de lealtad.
                    </div>
                </div>
                
                <!-- Categor√≠a Media (Amarillo) -->
                <div style="margin-bottom: 20px; padding: 12px; background: #fffbe6; border-left: 4px solid #faad14; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="width: 20px; height: 20px; background: #faad14; border-radius: 50%;"></div>
                        <strong style="color: #d48806; font-size: 14px;">Media Penetraci√≥n</strong>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        Provincias con ventas entre el <strong>33% y 66%</strong>
                    </div>
                    <div style="font-size: 12px; color: #333;">
                        <strong>üí° Acci√≥n:</strong> Incrementar frecuencia de visitas comerciales, campa√±as de marketing dirigidas, identificar nuevos clientes potenciales, ofrecer promociones estrat√©gicas.
                    </div>
                </div>
                
                <!-- Categor√≠a Baja (Rojo) -->
                <div style="margin-bottom: 20px; padding: 12px; background: #fff1f0; border-left: 4px solid #ff4d4f; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="width: 20px; height: 20px; background: #ff4d4f; border-radius: 50%;"></div>
                        <strong style="color: #cf1322; font-size: 14px;">Baja Penetraci√≥n</strong>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        Provincias con ventas en el <strong>bottom 33%</strong> o sin ventas
                    </div>
                    <div style="font-size: 12px; color: #333;">
                        <strong>üí° Acci√≥n:</strong> Asignar vendedor dedicado, realizar estudio de mercado, campa√±a de entrada agresiva, ofrecer incentivos especiales, identificar barreras de entrada.
                    </div>
                </div>
                
                <!-- Resumen Estad√≠stico -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e8e8e8;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 8px;">Resumen por Categor√≠a:</div>
                    <div id="mapa-resumen-categorias" style="font-size: 12px; color: #666;">
                        <div>üü¢ Alta: <span id="count-alta">-</span></div>
                        <div>üü° Media: <span id="count-media">-</span></div>
                        <div>üî¥ Baja: <span id="count-baja">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- üó∫Ô∏è MAPA GEOGR√ÅFICO DE PENETRACI√ìN -->
    <div class="grafico-container" style="margin-top: 30px; overflow: hidden;">
        <h3 style="margin-bottom: 20px;">
            <span style="font-size: 22px;">üó∫Ô∏è</span>
            Mapa Geogr√°fico de Penetraci√≥n por Departamento
        </h3>
        
        <div style="background: #f0f5ff; padding: 12px 15px; border-left: 4px solid #1890ff; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
            <div style="font-weight: 600; margin-bottom: 6px; color: #0050b3;">üéØ ¬øQu√© muestra?</div>
            <div style="color: #666; line-height: 1.6;">
                Distribuci√≥n de ventas por regi√≥n/departamento para identificar <strong>zonas de alta penetraci√≥n</strong> vs. 
                <strong>oportunidades de mercado sin explotar ("zonas blancas")</strong>. 
                <strong>Acci√≥n:</strong> Expandir cobertura en departamentos con bajo volumen pero alto potencial.
            </div>
        </div>
        
        <div style="position: relative; height: 450px; width: 100%;">
            <div id="graficoMapaGeografico" style="width: 100%; height: 100%;"></div>
        </div>
        
        <!-- Tabla de Departamentos -->
        <div style="margin-top: 20px;">
            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #333;">üìã Detalle por Departamento</h4>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e8e8e8; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead style="position: sticky; top: 0; background: #fafafa; z-index: 1;">
                        <tr>
                            <th style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #e8e8e8;">Departamento</th>
                            <th style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #e8e8e8;">Ventas (S/)</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #e8e8e8;">Clientes</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #e8e8e8;">Transacciones</th>
                            <th style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #e8e8e8;">Participaci√≥n</th>
                            <th style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid #e8e8e8;">Ticket Prom.</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for region in datos_geograficos %}
                        <tr style="border-bottom: 1px solid #f0f0f0; {% if loop.index <= 3 %}background: #f6ffed;{% endif %}">
                            <td style="padding: 10px; font-weight: {% if loop.index <= 3 %}600{% else %}400{% endif %};">
                                {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}üìç{% endif %}
                                {{ region.region }}
                            </td>
                            <td style="padding: 10px; text-align: right; font-family: 'Courier New', monospace;">
                                <strong>{{ "S/ {:,.0f}".format(region.ventas) }}</strong>
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                <span style="background: #e6f7ff; padding: 3px 10px; border-radius: 12px; font-weight: 600; color: #0050b3;">
                                    {{ region.clientes }}
                                </span>
                            </td>
                            <td style="padding: 10px; text-align: center; color: #666;">
                                {{ region.transacciones }}
                            </td>
                            <td style="padding: 10px; text-align: right;">
                                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                    <div style="flex: 1; max-width: 80px; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                        <div style="width: {{ region.participacion }}%; height: 100%; background: linear-gradient(90deg, #52c41a, #73d13d);"></div>
                                    </div>
                                    <span style="font-weight: 600; color: #52c41a; min-width: 50px;">{{ "%.1f"|format(region.participacion) }}%</span>
                                </div>
                            </td>
                            <td style="padding: 10px; text-align: right; font-family: 'Courier New', monospace; color: #666;">
                                S/ {{ "{:,.0f}".format(region.ticket_promedio) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Insights autom√°ticos -->
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <div style="padding: 15px; background: linear-gradient(135deg, #e6fffb 0%, #b5f5ec 100%); border-radius: 8px;">
                <div style="font-size: 11px; color: #006d75; font-weight: 600; margin-bottom: 5px;">üó∫Ô∏è EXPANSI√ìN DE MERCADO</div>
                <div style="font-size: 13px; color: #333; line-height: 1.5;">
                    Identificar "zonas blancas" para dirigir la expansi√≥n y capturar nuevo mercado potencial
                </div>
            </div>
            <div style="padding: 15px; background: linear-gradient(135deg, #fff7e6 0%, #ffd591 100%); border-radius: 8px;">
                <div style="font-size: 11px; color: #d46b08; font-weight: 600; margin-bottom: 5px;">üöö OPTIMIZACI√ìN LOG√çSTICA</div>
                <div style="font-size: 13px; color: #333; line-height: 1.5;">
                    Redise√±ar rutas comerciales bas√°ndose en la concentraci√≥n de clientes por departamento
                </div>
            </div>
            <div style="padding: 15px; background: linear-gradient(135deg, #f9f0ff 0%, #d3adf7 100%); border-radius: 8px;">
                <div style="font-size: 11px; color: #531dab; font-weight: 600; margin-bottom: 5px;">üéØ MARKETING LOCALIZADO</div>
                <div style="font-size: 13px; color: #333; line-height: 1.5;">
                    Lanzar campa√±as espec√≠ficas seg√∫n caracter√≠sticas demogr√°ficas de cada regi√≥n
                </div>
            </div>
        </div>
    </div>
    
    <!-- 
    GR√ÅFICOS DESACTIVADOS TEMPORALMENTE
    - Venta por tipo de Producto (Donut)
    - Top 7 Productos M√°s Vendidos
    - Venta por L√≠nea Comercial (Barras)
    - Ventas por Clasificaci√≥n Comercial
    - An√°lisis Jer√°rquico de Ventas
    - Venta por Clasificaci√≥n Farmacol√≥gica
    
    Para reactivarlos, descomenta los bloques correspondientes.
    -->
</div>

<style>
/* Importar fuente Poppins para un look m√°s Odoo */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

:root {
    --odoo-primary: #875A7B;
    --odoo-primary-dark: #6B4563;
}

/* === ESTILOS DEL DASHBOARD === */
body {
    margin: 0;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: #2c3e50;
}

/* Header estilo Odoo */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--odoo-primary) 0%, var(--odoo-primary-dark) 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(135, 90, 123, 0.3);
    margin-bottom: 25px;
    font-family: 'Poppins', sans-serif;
}

/* Estilo para el enlace en la tabla */
.tabla-avance td a {
    text-decoration: none;
    color: var(--odoo-primary);
    font-weight: 600;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 2px;
}

.header-info h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: white;
}

.header-username {
    font-size: 14px;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.8);
    padding-left: 2px;
}

/* Calendario central */
.calendario-dia {
    display: flex;
    flex-direction: row;
    align-items: center;
    background: #3498db;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    min-width: 60px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    gap: 8px;
}

.dia-numero {
    font-size: 24px;
    font-weight: bold;
    line-height: 1;
}

.dia-texto {
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
}



.header-nav {
    display: flex;
    gap: 15px;
    align-items: center;
}

#mes-selector {
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    font-size: 14px;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    font-family: 'Poppins', sans-serif;
}

#mes-selector option {
    background-color: #333;
    color: white;
}

.btn-nav, .btn-salir, .btn-nav:visited, .btn-salir:visited {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-nav {
    background-color: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-nav:hover {
    background-color: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
}

.btn-salir {
    background: #e74c3c;
    color: white;
}

.btn-salir:hover {
    background-color: #c0392b;
    transform: translateY(-1px);
}

/* Dashboard Container */
.dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* KPIs Row */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr); /* Ajustado a 6 columnas */
    gap: 15px;
}

.kpi-card {
    background: white;
    padding: 5px 15px; /* Aumentado padding para m√°s espacio interno */
    border-radius: 6px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    text-align: center;
    height: auto; /* Altura autom√°tica basada en contenido */
    min-height: 30px; /* Aumentado de 20px a 30px */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    /* Eliminar completamente cualquier animaci√≥n */
    transition: none !important;
    transform: none !important;
    animation: none !important;
    pointer-events: auto;
}
.kpi-card.kpi-meta {
    border-left: 4px solid #8e44ad;
}

.kpi-card.kpi-avance {
    border-left-color: #f39c12;
    background: #fff3cd;
}

.kpi-card.kpi-vencimiento {
    border-left-color: #3498db;
    background: #d6eaf8;
}

/* Eliminar cualquier estado hover, focus, active */
.kpi-card:hover,
.kpi-card:focus,
.kpi-card:active {
    transition: none !important;
    transform: none !important;
    animation: none !important;
}

.kpi-label {
    font-size: 12px; /* Tama√±o normal - NO reducir */
    color: #7f8c8d;
    margin-bottom: 2px; /* Peque√±o espacio entre label y valor */
    font-weight: 600;
    line-height: 1;
}

.kpi-value {
    font-size: 18px; /* Tama√±o normal - NO reducir */
    font-weight: bold;
    color: #2c3e50;
    line-height: 1;
}

/* Avance Diario - Layout agrupado con IPN a la derecha */
.avance-diario-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 columnas iguales para layout 4x1 */
    grid-template-rows: 1fr; /* 1 sola fila */
    gap: 15px;
    margin-bottom: 15px; /* Reducido de 20px a 15px */
    max-width: 100%;
    height: auto;
}

.avance-card-spacer {
    /* Ya no es necesario - eliminado para layout 2x2 */
    display: none;
}

.avance-card-placeholder {
    /* Ya no es necesario - eliminado para layout 2x2 */
    display: none;
}

/* Responsividad */
@media (max-width: 1200px) {
    .avance-diario-grid { 
        grid-template-columns: 1fr 1fr; /* 2x2 en tablets */
        grid-template-rows: 1fr 1fr;
    }
}

@media (max-width: 768px) {
    .avance-diario-grid { 
        grid-template-columns: 1fr; /* 1 columna en m√≥viles */
        grid-template-rows: repeat(4, auto); /* 4 filas para m√≥viles */
    }
}

.avance-card {
    background: #ecf0f1;
    padding: 10px 15px; /* Aumentado padding para mejor proporci√≥n */
    border-radius: 6px;
    text-align: center;
    height: auto; /* Altura autom√°tica basada en contenido */
    min-height: 70px; /* Aumentado para mejor proporci√≥n en grid 2x2 */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    /* Eliminar completamente cualquier animaci√≥n */
    transition: none !important;
    transform: none !important;
    animation: none !important;
}

.avance-label {
    font-size: 14px; /* Mantener tama√±o original */
    color: #7f8c8d;
    margin-bottom: 2px; /* Peque√±o espacio entre label y valor */
    line-height: 1;
}

.avance-value {
    font-size: 20px; /* Mantener tama√±o original */
    font-weight: bold;
    color: #e67e22;
    line-height: 1;
}

.avance-card.avance-requerido .avance-value {
    color: #e74c3c; /* Rojo para indicar urgencia */
}

/* Eliminar cualquier estado hover, focus, active en tarjetas de avance */
.avance-card:hover,
.avance-card:focus,
.avance-card:active {
    transition: none !important;
    transform: none !important;
    animation: none !important;
}

/* FILA 1: Tabla principal a ancho completo */
.main-table-row {
    /* No necesita grid, el contenedor de la tabla ocupar√° el 100% */
}

/* FILA 2: Dos tablas lado a lado 50-50 */
.secondary-content-row {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Dos columnas iguales (50% cada una) */
    gap: 25px;
    align-items: start;
}

/* Tabla Container (IZQUIERDA) */
.tabla-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.tabla-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 0 20px 0;
}

.tabla-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 18px;
}

.tabla-header-botones {
    display: flex;
    gap: 10px;
}

.btn-export-tabla {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background-color: #1D6F42; /* Verde Excel */
    color: white;
    border-radius: 5px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-custom-action {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    color: white;
    border-radius: 5px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
    transition: background-color 0.2s;
    background-color: var(--odoo-primary);
}
.btn-custom-action:hover {
    background-color: var(--odoo-primary-dark);
}

.tabla-avance {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

.tabla-avance th {
    background: var(--odoo-primary);
    color: white;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
}

.tabla-avance td {
    padding: 10px 8px;
    border-bottom: 1px solid #ecf0f1;
    text-align: center;
}

.tabla-avance .porcentaje {
    font-weight: bold;
    color: #e67e22;
}

.fila-total {
    background: var(--odoo-primary) !important;
    color: white !important;
}

.fila-total td {
    color: white !important;
    border-top: 2px solid var(--odoo-primary-dark);
}

/* Gr√°fico Ciclo de Vida (DERECHA) */
.grafico-ciclo-vida {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.grafico-ciclo-vida h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
    font-size: 18px;
}

.donut-container {
    position: relative;
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#grafico-donut {
    max-width: 100%;
    max-height: 100%;
}

/* Gr√°ficos Inferiores */
.graficos-inferiores {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
}

.grafico-productos, .grafico-lineas {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    /* SOLUCI√ìN: Evita que el contenido interno (canvas) cause desbordamiento */
    overflow: hidden;
}

.grafico-productos h3, .grafico-lineas h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
    font-size: 18px;
    text-align: center;
}

.chart-container {
    position: relative;
    height: 300px;
}

/* Estilos para el nuevo gr√°fico ECharts */
.grafico-extra-container {
    margin-top: 25px;
}
.grafico-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.grafico-echarts {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Estilos para el gauge de cobertura */
.cobertura-gauge {
    position: relative;
}

.gauge-circle {
    position: relative;
}

.gauge-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.gauge-value {
    font-size: 48px;
    font-weight: 700;
    margin-bottom: 5px;
}

.gauge-label {
    font-size: 18px;
    color: #666;
    font-weight: 500;
}

/* Responsive */
@media (max-width: 1200px) {
    .kpi-row {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .secondary-content-row {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 20px;
    }
    
    .kpi-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .secondary-content-row {
        grid-template-columns: 1fr;
    }
}

/* Estilos para el mapa con sem√°foro */
@media (max-width: 1200px) {
    div[style*="grid-template-columns: 1fr 350px"] {
        grid-template-columns: 1fr !important;
    }
    
    #mapa-leyenda-semaforo {
        margin-top: 20px;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos del backend para los gr√°ficos (con valores positivos)
const datosLineas = {{ datos_lineas|tojson|safe }};
const datosProductos = {{ datos_productos|tojson|safe }};
const datosCicloVida = {{ datos_ciclo_vida|tojson|safe }};

// --- NUEVO C√ìDIGO PARA MAPA GEOGR√ÅFICO ---

// Helper para normalizar nombres de departamentos (ej: "San Mart√≠n" -> "SAN MARTIN")
function normalizarNombre(str) {
    if (!str) return '';
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
}

// Funci√≥n para crear el Mapa Geogr√°fico de Penetraci√≥n
function crearGraficoMapaGeografico() {
    console.log('üó∫Ô∏è Creando mapa geogr√°fico...');
    const chartDom = document.getElementById('graficoMapaGeografico');
    const mapaVentasData = {{ mapa_ventas_data|tojson|safe }};

    if (!chartDom || !mapaVentasData || mapaVentasData.length === 0) {
        const container = document.getElementById('graficoMapaGeografico');
        if(container) {
            // Si el contenedor del mapa existe pero no hay datos, muestra un mensaje.
            container.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">No hay datos geogr√°ficos para mostrar en el mapa.</div>';
        }
        console.warn('‚ö†Ô∏è No se encontraron datos o el contenedor para el mapa geogr√°fico.');
        return;
    }

    // URL del GeoJSON para los departamentos de Per√∫
    const peruGeoJsonUrl = 'https://raw.githubusercontent.com/juaneladio/peru-geojson/master/peru_departamental_simple.geojson';

    fetch(peruGeoJsonUrl)
        .then(response => response.json())
        .then(peruGeoJson => {
            console.log('‚úÖ GeoJSON de Per√∫ cargado exitosamente.');
            echarts.registerMap('PERU', peruGeoJson);

            const myChart = echarts.init(chartDom);

            // Crear un mapa de nombres normalizados para b√∫squeda r√°pida. Almacena el objeto completo.
            const ventasMap = new Map();
            mapaVentasData.forEach(item => {
                // Asegurarse que el backend envia 'departamento' y 'venta'
                if(item.departamento && item.venta) {
                    ventasMap.set(normalizarNombre(item.departamento), item);
                }
            });

            // Preparar los datos para ECharts, uniendo GeoJSON con datos de ventas
            const dataForMap = peruGeoJson.features.map(feature => {
                const nombreNormalizado = normalizarNombre(feature.properties.NOMBDEP);
                const ventaData = ventasMap.get(nombreNormalizado);
                return {
                    name: feature.properties.NOMBDEP,
                    value: ventaData ? ventaData.venta : 0,
                    pedidos: ventaData ? ventaData.pedidos : 0
                };
            });
            
            const maxVenta = Math.max(...dataForMap.map(d => d.value));

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        // params.data contiene el objeto completo: {name, value, pedidos}
                        if (params.data && typeof params.data.value !== 'undefined' && params.data.value > 0) {
                            let tooltipHtml = `<strong>${params.name}</strong><br/>`;
                            tooltipHtml += `Venta: <strong>S/ ${params.data.value.toLocaleString('es-PE', {maximumFractionDigits: 0})}</strong>`;
                            
                            if (params.data.pedidos) {
                                tooltipHtml += `<br/>N¬∞ Pedidos: <strong>${params.data.pedidos}</strong>`;
                            }
                            
                            return tooltipHtml;
                        }
                        return `<strong>${params.name}</strong><br/>Sin ventas registradas`;
                    }
                },
                visualMap: {
                    left: 'left',
                    min: 0,
                    max: maxVenta > 0 ? maxVenta : 1, // Evitar max=0 si no hay ventas
                    inRange: {
                        color: ['#E6F7FF', '#91D5FF', '#40A9FF', '#1890FF', '#0050B3']
                    },
                    text: ['Alta', 'Baja'],
                    calculable: true
                },
                series: [
                    {
                        name: 'Ventas por Departamento',
                        type: 'map',
                        map: 'PERU',
                        roam: true, // Permite zoom y paneo
                        emphasis: {
                            label: {
                                show: true,
                                color: '#000'
                            },
                            itemStyle: {
                                areaColor: '#faad14'
                            }
                        },
                        data: dataForMap
                    }
                ]
            };

            myChart.setOption(option);
            console.log('‚úÖ Mapa geogr√°fico renderizado.');
        })
        .catch(error => {
            console.error('‚ùå Error al cargar o procesar el GeoJSON:', error);
            const container = document.getElementById('graficoMapaGeografico');
            if(container){
                container.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #c0392b; background: #f8f9fa; border-radius: 8px;">Error al cargar el mapa. Verifique la conexi√≥n.</div>';
            }
        });
}
// --- FIN NUEVO C√ìDIGO ---

// Gr√°fico de Ciclo de Vida (Donut)
function crearGraficoCicloVida() {
    const chartDom = document.getElementById('grafico-donut');
    // --- FIX: A√±adir comprobaci√≥n para evitar error si el elemento no existe ---
    if (!chartDom) {
        console.warn("‚ö†Ô∏è Elemento 'grafico-donut' no encontrado. Saltando creaci√≥n de gr√°fico de ciclo de vida.");
        return;
    }
    // --------------------------------------------------------------------
    const myChart = echarts.init(chartDom);

    const seriesData = datosCicloVida.map(item => ({
        name: item.ciclo || 'Sin definir',
        value: item.venta || 0
    }));

    const option = {
        tooltip: {
            trigger: 'item',
            formatter: function(params) {
                const value = (params.value || 0).toLocaleString('es-PE', { style: 'currency', currency: 'PEN', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                return `${params.seriesName}<br/>${params.name}: ${value} (${params.percent}%)`;
            }
        },
        legend: {
            top: '5%',
            left: 'center',
            type: 'scroll'
        },
        series: [
            {
                name: 'Tipo de Producto',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: '30',
                        fontWeight: 'bold'
                    }
                },
                labelLine: {
                    show: false
                },
                data: seriesData
            }
        ]
    };

    myChart.setOption(option);
}

// Gr√°fico de Productos (Barras Horizontales)
let productosChart = null; // Variable global para la instancia del gr√°fico
function crearGraficoProductos(productosData) {
    const ctx = document.getElementById('grafico-productos').getContext('2d');
    
    // Si no se pasan datos, usar los datos iniciales
    if (!productosData) {
        productosData = datosProductos.map(p => ({nombre: p.nombre, venta: p.venta}));
    }

    const labels = productosData.map(item => (item.nombre || item[0]).length > 20 ? (item.nombre || item[0]).substring(0, 20) + '...' : (item.nombre || item[0]));
    const data = productosData.map(item => item.venta || item[1] || 0);
    
    // Si el gr√°fico ya existe, lo destruimos para crearlo de nuevo
    if (productosChart) {
        productosChart.destroy();
    }

    productosChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ventas',
                data: data,
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // Barras horizontales
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: (context) => 'Ventas: S/ ' + (context.parsed.x || 0).toLocaleString('es-PE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'S/ ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Gr√°fico de L√≠neas Comerciales (Barras Verticales)
function crearGraficoLineas() {
    const ctx = document.getElementById('grafico-lineas').getContext('2d');
    // --- FIX: A√±adir comprobaci√≥n para evitar error si el canvas no existe ---
    if (!ctx) {
        console.warn("‚ö†Ô∏è Elemento 'grafico-lineas' no encontrado. Saltando creaci√≥n de gr√°fico.");
        return;
    }
    // --------------------------------------------------------------------
    // Usar una copia ordenada por 'meta' descendente para mostrar las barras de mayor a menor por meta
    const datosLineasSorted = Array.isArray(datosLineas) ? [...datosLineas].sort((a, b) => (b.meta || 0) - (a.meta || 0)) : [];

    const labels = datosLineasSorted.map(item => item.nombre);
    const dataMeta = datosLineasSorted.map(item => item.meta || 0);
    const dataVenta = datosLineasSorted.map(item => item.venta || 0);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Meta',
                    data: dataMeta,
                    backgroundColor: '#e74c3c',
                    borderColor: '#c0392b',
                    borderWidth: 1
                },
                {
                    label: 'Venta',
                    data: dataVenta,
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: (context) =>
                            `${context.dataset.label}: S/ ${(context.parsed.y || 0).toLocaleString('es-PE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'S/ ' + (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

/*
// Gr√°fico de Forma Farmac√©utica con ECharts
let clasificacionChart = null; // Instancia global del gr√°fico
function crearGraficoFormaFarmaceutica(chartData, title) {
    const chartDom = document.getElementById('grafico-forma-farmaceutica');
    if (!clasificacionChart) {
        clasificacionChart = echarts.init(chartDom);
    }

    // Si no se pasan datos, usar los datos iniciales
    if (!chartData) {
        chartData = datosFormaFarmaceutica.map(item => ({
            name: item.forma,
            value: item.venta || 0
        }));
    }
    if (!title) {
        title = 'Venta por Clasificaci√≥n Farmacol√≥gica';
    }

    const legendData = chartData.map(item => item.name);
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: function(params) {
                const value = (params.value || 0).toLocaleString('es-PE', { style: 'currency', currency: 'PEN', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                return `${params.seriesName}<br/>${params.name}: ${value} (${params.percent}%)`;
            }
        },
        legend: {
            type: 'scroll',
            orient: 'vertical',
            right: 10,
            top: 20,
            bottom: 20,
            data: legendData
        },
        title: {
            text: title,
            left: 'center',
            top: 5,
            textStyle: { fontSize: 16 }
        },
        series: [
            {
                name: 'Clasificaci√≥n',
                type: 'pie',
                radius: '60%', // Un poco m√°s peque√±o para el t√≠tulo
                center: ['40%', '50%'], // Mueve el gr√°fico a la izquierda para dar espacio a la leyenda
                data: chartData,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    clasificacionChart.setOption(option, true); // true para limpiar el gr√°fico anterior
}
*/

/*
// Gr√°fico Drilldown Jer√°rquico
function crearGraficoDrilldown() {
    const chartDom = document.getElementById('grafico-drilldown');
    if (!chartDom) return;
    const myChart = echarts.init(chartDom);
    let currentTitle = '';

    const allOptions = {};
    for (const [optionId, data] of Object.entries(drilldownData)) {
        const option = {
            id: optionId,
            xAxis: {
                type: 'category',
                axisLabel: {
                    interval: 0,
                    rotate: 30,
                    formatter: function (value) {
                        // Acortar etiquetas largas para que no se superpongan
                        const maxLength = 15;
                        return value.length > maxLength ? value.substring(0, maxLength) + '...' : value;
                    }
                }
            },
            yAxis: {
                minInterval: 1,
                axisLabel: {
                    formatter: function (value) {
                        return 'S/ ' + Math.round(value).toLocaleString('es-PE');
                    }
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    const value = (params.value[1] || 0).toLocaleString('es-PE', { style: 'currency', currency: 'PEN', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    return `${params.name}<br/>Venta: ${value}`;
                }
            },
            animationDurationUpdate: 500,
            series: {
                type: 'bar',
                dimensions: ['x', 'y', 'groupId', 'childGroupId'],
                encode: {
                    x: 0, // Nombre
                    y: 1, // Valor
                    itemGroupId: 2,
                    itemChildGroupId: 3
                },
                data: data,
                universalTransition: {
                    enabled: true,
                    divideShape: 'clone'
                }
            },
            graphic: [
                {
                    type: 'text',
                    left: 50,
                    top: 20,
                    style: {
                        text: 'Volver',
                        fontSize: 18,
                        fill: 'grey',
                        fontWeight: 'bold'
                    },
                    onclick: function () {
                        goBack();
                    }
                }
                ,
                {
                    id: 'title',
                    type: 'text',
                    left: 'center',
                    top: 10,
                    style: {
                        text: drilldownTitles[optionId] || '',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                }
            ]
        };
        allOptions[optionId] = option;
    }

    const optionStack = [];
    const goForward = (optionId) => {
        if (allOptions[optionId]) {
            optionStack.push(myChart.getOption().id);
            myChart.setOption(allOptions[optionId]);
            // Actualizar gr√°fico de productos
            crearGraficoProductos(topProductsByLevel[optionId] || []);
            // Actualizar gr√°fico de pastel
            crearGraficoFormaFarmaceutica(pieChartDataByLevel[optionId] || [], drilldownTitles[optionId] || '');
        }
    };
    const goBack = () => {
        if (optionStack.length > 0) {
            const prevOptionId = optionStack.pop();
            myChart.setOption(allOptions[prevOptionId]);
            // Actualizar gr√°fico de productos
            crearGraficoProductos(topProductsByLevel[prevOptionId] || []);
            // Actualizar gr√°fico de pastel
            crearGraficoFormaFarmaceutica(pieChartDataByLevel[prevOptionId] || [], drilldownTitles[prevOptionId] || '');
        }
    };

    myChart.on('click', 'series', (params) => {
        const dataItem = params.data;
        if (dataItem && dataItem[3]) { // Si tiene un childGroupId
            const nextOptionId = dataItem[3];
            goForward(nextOptionId);
        }
    });

    // Cargar la opci√≥n inicial
    if (allOptions['root']) {
        myChart.setOption(allOptions['root']);
    }
}
*/

/*
// Nuevo gr√°fico de Barras Apiladas con Selector
let stackedChart = null;
let lineSelector = null;

function updateStackedChart() {
    const chartDom = document.getElementById('stacked-chart-container');
    if (!chartDom) return;
    if (!stackedChart) {
        stackedChart = echarts.init(chartDom);
    }

    const dimension = document.getElementById('stacked-chart-selector').value;
    const selectedLines = lineSelector.getValue();
    const chartData = allStackedChartData[dimension];

    if (!chartData) return;

    // Filtrar datos seg√∫n las l√≠neas comerciales seleccionadas
    const filteredYAxis = chartData.yAxis.filter(line => selectedLines.includes(line));
    const filteredSeries = chartData.series.map(s => {
        const newData = [];
        chartData.yAxis.forEach((line, index) => {
            if (selectedLines.includes(line)) {
                newData.push(s.data[index]);
            }
        });
        return { ...s, data: newData };
    });

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: function (params) {
                let tooltipText = `${params[0].axisValue}<br/>`;
                let total = 0;
                params.sort((a, b) => b.value - a.value);
                params.forEach(param => {
                    const value = param.value || 0;
                    if (value !== 0) {
                        tooltipText += `${param.marker} ${param.seriesName}: ${Math.round(value).toLocaleString('es-PE')}<br/>`;
                    }
                    total += value;
                });
                tooltipText += `<strong>Total: ${Math.round(total).toLocaleString('es-PE')}</strong>`;
                return tooltipText;
            }
        },
        legend: {
            type: 'scroll',
            orient: 'horizontal',
            bottom: 10,
            left: 'center'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: 60,
            containLabel: true
        },
        xAxis: {
            type: 'value',
            min: 0
        },
        yAxis: {
            type: 'category',
            data: filteredYAxis
        },
        series: filteredSeries
    };

    stackedChart.setOption(option, true);
}
*/

// Funci√≥n para crear el gr√°fico de cobertura de clientes (SVG mejorado)
function crearGraficoCobertura() {
    const coberturaValue = {{ kpis.cobertura_clientes|default(0)|round(2) }};
    
    console.log('‚ú® Creando gauge de cobertura SVG:', coberturaValue);
    
    // Determinar color seg√∫n el PRD
    let color = '#ff4d4f'; // Rojo para < 50%
    let label = 'BAJO';
    if (coberturaValue >= 70) {
        color = '#52c41a'; // Verde para excelencia
        label = 'EXCELENTE';
    } else if (coberturaValue >= 65) {
        color = '#faad14'; // Amarillo para meta alcanzada
        label = 'META ALCANZADA';
    } else if (coberturaValue >= 50) {
        color = '#ff7a45'; // Naranja para valores medios
        label = 'REGULAR';
    }
    
    // Calcular el stroke-dashoffset (817 es la circunferencia: 2 * œÄ * 130)
    const radius = 130;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (circumference * coberturaValue / 100);
    
    // Aplicar estilos al c√≠rculo de progreso
    const circle = document.getElementById('coberturaCircle');
    const valueEl = document.getElementById('coberturaValue');
    const labelEl = document.getElementById('coberturaLabel');
    
    if (circle) {
        // Usar el gradiente si el valor es alto, sino color s√≥lido
        if (coberturaValue >= 50) {
            circle.style.stroke = 'url(#progressGradient)';
        } else {
            circle.style.stroke = color;
        }
        circle.style.strokeDashoffset = offset;
    }
    
    if (valueEl) {
        valueEl.style.color = color;
    }
    
    if (labelEl) {
        labelEl.textContent = label;
        labelEl.style.color = color;
    }
    
    console.log('‚úÖ Gauge SVG configurado:', { 
        valor: coberturaValue, 
        color, 
        label, 
        offset: offset.toFixed(2),
        circumference: circumference.toFixed(2)
    });
}

// Funci√≥n para crear el gr√°fico de frecuencia de compra por l√≠nea comercial (con ECharts)
function crearGraficoFrecuenciaLinea() {
    console.log('üîÑ Iniciando creaci√≥n de gr√°fico de frecuencia con ECharts...');
    
    const chartDom = document.getElementById('graficoFrecuenciaLinea');
    if (!chartDom) {
        console.error('‚ùå Elemento para el gr√°fico de frecuencia (graficoFrecuenciaLinea) no encontrado.');
        return; // No hacer nada si el elemento no existe
    }
    
    // Inicializar instancia de ECharts
    const myChart = echarts.init(chartDom);
    
    const datosFrecuencia = {{ datos_frecuencia_linea|default([])|tojson|safe }};
    console.log('üìä Datos de frecuencia recibidos para ECharts:', datosFrecuencia);

    if (!datosFrecuencia || datosFrecuencia.length <= 1) { // <= 1 para ignorar si solo est√° el total
        console.error('‚ùå No hay datos de frecuencia para ECharts.');
        return;
    }

    const datosLineas = datosFrecuencia.filter(d => !d.es_total).sort((a, b) => b.frecuencia - a.frecuencia);
    if (datosLineas.length === 0) {
        console.error('‚ùå No hay l√≠neas para graficar despu√©s de filtrar el total.');
        return;
    }
    
    const labels = datosLineas.map(d => d.linea);
    const frecuencias = datosLineas.map(d => d.frecuencia);
    const clientes = datosLineas.map(d => d.clientes_activos);
    const pedidos = datosLineas.map(d => d.pedidos);

    const dataForChart = datosLineas.map(d => ({
        value: d.frecuencia,
        itemStyle: {
            color: d.frecuencia >= 2 ? '#52c41a' : (d.frecuencia >= 1 ? '#faad14' : '#ff4d4f')
        }
    }));

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: function (params) {
                const index = params[0].dataIndex;
                const linea = labels[index];
                const frecuencia = frecuencias[index].toFixed(2);
                const numClientes = clientes[index];
                const numPedidos = pedidos[index];
                
                return `<strong>${linea}</strong><br/>
                        Frecuencia: ${frecuencia} pedidos/cliente<br/>
                        Clientes: ${numClientes}<br/>
                        Pedidos: ${numPedidos}`;
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: labels,
            axisLabel: {
                rotate: 45,
                interval: 0
            }
        },
        yAxis: {
            type: 'value',
            min: 0,
            axisLabel: {
                formatter: '{value}'
            }
        },
        series: [{
            name: 'Frecuencia',
            type: 'bar',
            barWidth: '60%',
            data: dataForChart,
            label: {
                show: true,
                position: 'top',
                formatter: function(params) {
                    return params.value.toFixed(2);
                },
                color: '#333'
            }
        }]
    };

    myChart.setOption(option);
    console.log('‚úÖ Gr√°fico de frecuencia de compra con ECharts creado exitosamente.');
}

// Funci√≥n para crear el gr√°fico de tendencia hist√≥rica (12 meses)
function crearGraficoTendencia12Meses() {
    console.log('üìà Creando gr√°fico de tendencia hist√≥rica...');
    
    const ctx = document.getElementById('graficoTendencia12Meses');
    if (!ctx) {
        console.error('‚ùå Canvas graficoTendencia12Meses no encontrado');
        return;
    }

    const datosTendencia = {{ tendencia_12_meses|default([])|tojson|safe }};
    console.log('üìä Datos tendencia recibidos:', datosTendencia);
    
    if (!datosTendencia || datosTendencia.length === 0) {
        console.error('‚ùå No hay datos de tendencia disponibles');
        return;
    }
    
    // Extraer datos
    const labels = datosTendencia.map(d => d.mes_nombre);
    const ventas = datosTendencia.map(d => d.venta);
    const metas = datosTendencia.map(d => d.meta);
    const cumplimiento = datosTendencia.map(d => d.cumplimiento);
    
    // Calcular l√≠nea de tendencia lineal (regresi√≥n lineal simple)
    const calcularTendenciaLineal = (datos) => {
        const n = datos.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        
        datos.forEach((y, x) => {
            sumX += x;
            sumY += y;
            sumXY += x * y;
            sumX2 += x * x;
        });
        
        const pendiente = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercepto = (sumY - pendiente * sumX) / n;
        
        return datos.map((_, x) => pendiente * x + intercepto);
    };
    
    const tendenciaLineal = calcularTendenciaLineal(ventas);
    
    console.log('üìä Labels:', labels);
    console.log('üìä Ventas:', ventas);
    console.log('üìä Metas:', metas);
    console.log('üìà Tendencia lineal calculada:', tendenciaLineal);
    
    try {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Venta Real',
                        data: ventas,
                        borderColor: '#875A7B',
                        backgroundColor: 'rgba(135, 90, 123, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#875A7B',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        order: 2
                    },
                    {
                        label: 'Meta',
                        data: metas,
                        borderColor: '#faad14',
                        backgroundColor: 'rgba(250, 173, 20, 0.05)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#faad14',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        order: 3
                    },
                    {
                        label: 'Tendencia',
                        data: tendenciaLineal,
                        borderColor: '#52c41a',
                        backgroundColor: 'transparent',
                        borderWidth: 2.5,
                        borderDash: [10, 5],
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 13, weight: '600' },
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                const label = context.dataset.label;
                                const value = context.parsed.y;
                                
                                if (label === 'Venta Real') {
                                    return [
                                        `${label}: S/ ${value.toLocaleString('es-PE')}`,
                                        `Cumplimiento: ${cumplimiento[index].toFixed(1)}%`
                                    ];
                                }
                                return `${label}: S/ ${value.toLocaleString('es-PE')}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: { size: 11 },
                            callback: function(value) {
                                return 'S/ ' + (value / 1000).toFixed(0) + 'K';
                            }
                        },
                        grid: {
                            color: '#e8e8e8',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 11 },
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico de tendencia hist√≥rica creado exitosamente');
    } catch (error) {
        console.error('‚ùå Error al crear gr√°fico de tendencia:', error);
    }
}

// Funci√≥n para crear el gr√°fico de segmentos RFM
function crearGraficoSegmentosRFM() {
    console.log('üéØ Creando gr√°fico de segmentos RFM...');
    
    const ctx = document.getElementById('graficoSegmentosRFM');
    if (!ctx) {
        console.error('‚ùå Canvas graficoSegmentosRFM no encontrado');
        return;
    }

    const segmentosRFM = {{ segmentos_rfm|default({})|tojson|safe }};
    console.log('üìä Datos RFM recibidos:', segmentosRFM);
    
    if (!segmentosRFM || Object.keys(segmentosRFM).length === 0) {
        console.error('‚ùå No hay datos de segmentos RFM disponibles');
        return;
    }
    
    // Orden de segmentos para el gr√°fico
    const ordenSegmentos = ['Campeones', 'Leales', 'Potenciales', 'Nuevos', 'En Riesgo', 'Hibernando', 'Perdidos', 'Otros'];
    
    // Extraer datos ordenados
    const labels = [];
    const counts = [];
    const valores = [];
    const colores = [];
    
    ordenSegmentos.forEach(segmento => {
        if (segmentosRFM[segmento]) {
            labels.push(segmento);
            counts.push(segmentosRFM[segmento].count);
            valores.push(segmentosRFM[segmento].valor);
            colores.push(segmentosRFM[segmento].color);
        }
    });
    
    console.log('üìä Segmentos:', labels);
    console.log('üìä Counts:', counts);
    
    try {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: colores,
                    borderColor: '#fff',
                    borderWidth: 3,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            font: { size: 11 },
                            usePointStyle: true,
                            padding: 12,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: `${label} (${data.datasets[0].data[i]})`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                const label = context.label;
                                const count = context.parsed;
                                const valor = valores[index];
                                const total = counts.reduce((a, b) => a + b, 0);
                                const porcentaje = ((count / total) * 100).toFixed(1);
                                
                                return [
                                    `${label}: ${count} clientes (${porcentaje}%)`,
                                    `Valor: S/ ${valor.toLocaleString('es-PE')}`
                                ];
                            }
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico de segmentos RFM creado exitosamente');
    } catch (error) {
        console.error('‚ùå Error al crear gr√°fico RFM:', error);
    }
}


// --- NUEVO C√ìDIGO PARA MAPA GEOGR√ÅFICO ---

// Helper para normalizar nombres de departamentos (ej: "San Mart√≠n" -> "SAN MARTIN")
// Elimina tildes, convierte a may√∫sculas y elimina sufijos como "(PE)"
function normalizarNombre(str) {
    if (!str) return '';
    // Eliminar sufijos comunes como "(PE)", "(PE )", etc.
    let nombre = str.replace(/\s*\(PE\)\s*/gi, '').trim();
    // Normalizar: quitar tildes y convertir a may√∫sculas
    nombre = nombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
    return nombre;
}

// Funci√≥n para crear el Mapa Geogr√°fico de Penetraci√≥n
function crearGraficoMapaGeografico() {
    console.log('üó∫Ô∏è Creando mapa geogr√°fico...');
    const chartDom = document.getElementById('graficoMapaGeografico');
    const mapaVentasData = {{ mapa_ventas_data|tojson|safe }};

    if (!chartDom || !mapaVentasData || mapaVentasData.length === 0) {
        const container = document.getElementById('graficoMapaGeografico');
        if(container) {
            container.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">No hay datos geogr√°ficos para mostrar en el mapa.</div>';
        }
        console.warn('‚ö†Ô∏è No se encontraron datos o el contenedor para el mapa geogr√°fico.');
        return;
    }

    console.log('üìä Datos recibidos del backend:', mapaVentasData);

    // URL del GeoJSON para los departamentos de Per√∫
    const peruGeoJsonUrl = 'https://raw.githubusercontent.com/juaneladio/peru-geojson/master/peru_departamental_simple.geojson';

    fetch(peruGeoJsonUrl)
        .then(response => response.json())
        .then(peruGeoJson => {
            console.log('‚úÖ GeoJSON de Per√∫ cargado exitosamente.');
            echarts.registerMap('PERU', peruGeoJson);

            const myChart = echarts.init(chartDom);

            // Crear un mapa de nombres normalizados para b√∫squeda r√°pida
            // FIX: El backend env√≠a 'name' y 'value', no 'departamento' y 'venta'
            const ventasMap = new Map();
            mapaVentasData.forEach(item => {
                const nombreNormalizado = normalizarNombre(item.name || item.departamento);
                const valorVenta = item.value !== undefined ? item.value : (item.venta !== undefined ? item.venta : 0);
                if (nombreNormalizado) {
                    ventasMap.set(nombreNormalizado, valorVenta);
                    console.log(`  üìç Mapeando: "${item.name || item.departamento}" (normalizado: "${nombreNormalizado}") = S/ ${valorVenta.toLocaleString('es-PE')}`);
                }
            });

            // Preparar los datos para ECharts, uniendo GeoJSON con datos de ventas
            const dataForMap = peruGeoJson.features.map(feature => {
                const nombreGeoJson = feature.properties.NOMBDEP;
                const nombreNormalizado = normalizarNombre(nombreGeoJson);
                const valorVenta = ventasMap.get(nombreNormalizado) || 0;
                
                if (valorVenta > 0) {
                    console.log(`  ‚úÖ Encontrado: ${nombreGeoJson} (normalizado: "${nombreNormalizado}") = S/ ${valorVenta.toLocaleString('es-PE')}`);
                }
                
                return {
                    name: nombreGeoJson,
                    value: valorVenta
                };
            });
            
            console.log('üó∫Ô∏è Datos del mapa normalizados:', dataForMap);
            
            // Calcular percentiles para categorizaci√≥n tipo sem√°foro
            // Ordenar valores de mayor a menor para calcular percentiles correctamente
            const valoresVentas = dataForMap.map(d => d.value).filter(v => v > 0).sort((a, b) => b - a);
            const totalValores = valoresVentas.length;
            
            let percentil33 = 0; // Top 33% (valores m√°s altos)
            let percentil66 = 0; // Entre 33% y 66% (valores medios)
            
            if (totalValores > 0) {
                // El percentil 33 es el valor en la posici√≥n que separa el top 33%
                const indice33 = Math.max(0, Math.floor(totalValores * 0.33) - 1);
                // El percentil 66 es el valor en la posici√≥n que separa el 33%-66%
                const indice66 = Math.max(0, Math.floor(totalValores * 0.66) - 1);
                percentil33 = valoresVentas[indice33] || 0;
                percentil66 = valoresVentas[indice66] || 0;
            }
            
            console.log(`üìä Percentiles calculados: P33 (top 33%)=${percentil33.toLocaleString('es-PE')}, P66 (33-66%)=${percentil66.toLocaleString('es-PE')}`);
            
            // Categorizar cada provincia y agregar informaci√≥n de categor√≠a
            let countAlta = 0, countMedia = 0, countBaja = 0;
            
            const dataForMapCategorizada = dataForMap.map(d => {
                let categoria = 'baja';
                let categoriaLabel = 'Baja Penetraci√≥n';
                
                if (d.value === 0) {
                    categoria = 'baja';
                    categoriaLabel = 'Sin Ventas';
                    countBaja++;
                } else if (d.value >= percentil33) {
                    // Top 33% - Alta penetraci√≥n
                    categoria = 'alta';
                    categoriaLabel = 'Alta Penetraci√≥n';
                    countAlta++;
                } else if (d.value >= percentil66) {
                    // Entre 33% y 66% - Media penetraci√≥n
                    categoria = 'media';
                    categoriaLabel = 'Media Penetraci√≥n';
                    countMedia++;
                } else {
                    // Bottom 33% - Baja penetraci√≥n
                    categoria = 'baja';
                    categoriaLabel = 'Baja Penetraci√≥n';
                    countBaja++;
                }
                
                return {
                    ...d,
                    categoria: categoria,
                    categoriaLabel: categoriaLabel
                };
            });
            
            // Actualizar el resumen estad√≠stico
            document.getElementById('count-alta').textContent = countAlta;
            document.getElementById('count-media').textContent = countMedia;
            document.getElementById('count-baja').textContent = countBaja;
            
            const maxVenta = Math.max(...dataForMap.map(d => d.value));

            const option = {
                tooltip: {
                    trigger: 'item',
                    showDelay: 0,
                    transitionDuration: 0.2,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    textStyle: {
                        color: '#fff',
                        fontSize: 13
                    },
                    formatter: function (params) {
                        const data = params.data || {};
                        const value = (data.value || 0).toLocaleString('es-PE', { style: 'currency', currency: 'PEN' });
                        const categoria = data.categoriaLabel || 'Sin categor√≠a';
                        const icono = data.categoria === 'alta' ? 'üü¢' : (data.categoria === 'media' ? 'üü°' : 'üî¥');
                        return `
                            <div style="padding: 5px;">
                                <strong>${params.name}</strong><br/>
                                ${icono} <strong>${categoria}</strong><br/>
                                Venta: <strong>${value}</strong>
                            </div>
                        `;
                    }
                },
                visualMap: {
                    left: 'left',
                    min: 0,
                    max: maxVenta > 0 ? maxVenta : 1,
                    type: 'piecewise', // Usar tipo piecewise para categor√≠as discretas
                    pieces: [
                        {min: percentil33, max: Infinity, label: 'Alta Penetraci√≥n', color: '#52c41a'},
                        {min: percentil66, max: percentil33, label: 'Media Penetraci√≥n', color: '#faad14'},
                        {min: 0.01, max: percentil66, label: 'Baja Penetraci√≥n', color: '#ff4d4f'},
                        {value: 0, label: 'Sin Ventas', color: '#d9d9d9'}
                    ],
                    text: ['Alta', 'Baja'],
                    textStyle: {
                        color: '#333',
                        fontSize: 11
                    },
                    calculable: false,
                    itemWidth: 15,
                    itemHeight: 10
                },
                series: [
                    {
                        name: 'Ventas por Departamento',
                        type: 'map',
                        map: 'PERU',
                        roam: true,
                        label: {
                            show: false
                        },
                        emphasis: {
                            label: {
                                show: true,
                                color: '#000',
                                fontWeight: 'bold',
                                fontSize: 12
                            },
                            itemStyle: {
                                borderColor: '#000',
                                borderWidth: 2
                            }
                        },
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        data: dataForMapCategorizada
                    }
                ]
            };

            myChart.setOption(option);
            console.log('‚úÖ Mapa geogr√°fico renderizado.');
        })
        .catch(error => {
            console.error('‚ùå Error al cargar o procesar el GeoJSON:', error);
            const container = document.getElementById('graficoMapaGeografico');
            if(container){
                container.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #c0392b; background: #f8f9fa; border-radius: 8px;">Error al cargar el mapa. Verifique la conexi√≥n a internet.</div>';
            }
        });
}
// --- FIN NUEVO C√ìDIGO ---

// Inicializar gr√°ficos cuando la p√°gina carga
document.addEventListener('DOMContentLoaded', function() {
    // FIX: Se comenta la llamada ya que el elemento 'grafico-donut' est√° deshabilitado en el HTML.
    // crearGraficoCicloVida(ceutica();
    // crearGraficoDrilldown();

    // --- Flatpickr Initialization ---
    const mesSeleccionado = document.getElementById('mes-selector').value; // "YYYY-MM"
    const [year, month] = mesSeleccionado.split('-').map(Number);
    const lastDayOfMonth = new Date(year, month, 0).getDate();
    const diaFinParam = new URLSearchParams(window.location.search).get('dia_fin') || '{{ dia_actual }}';

    flatpickr("#date-picker-trigger", {
        defaultDate: `${mesSeleccionado}-${String(diaFinParam).padStart(2, '0')}`,
        minDate: `${mesSeleccionado}-01`,
        maxDate: `${mesSeleccionado}-${lastDayOfMonth}`,
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length > 0) {
                const selectedDay = selectedDates[0].getDate();
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('dia_fin', selectedDay);
                if (!currentUrl.searchParams.has('mes')) {
                    currentUrl.searchParams.set('mes', mesSeleccionado);
                }
                window.location.href = currentUrl.toString();
            }
        },
    });

    // Funci√≥n para crear el heatmap de actividad de ventas
    function crearGraficoHeatmapVentas() {
        console.log('üî• Creando heatmap de actividad de ventas...');
        
        const container = document.getElementById('graficoHeatmapVentas');
        if (!container) {
            console.error('‚ùå Contenedor graficoHeatmapVentas no encontrado');
            return;
        }
        
        const datosHeatmap = {{ heatmap_ventas|default([])|tojson|safe }};
        const diasLabels = {{ heatmap_dias|default([])|tojson|safe }};
        const semanasLabels = {{ heatmap_semanas|default([])|tojson|safe }};
        
        console.log('üìä Datos heatmap:', datosHeatmap);
        
        if (!datosHeatmap || datosHeatmap.length === 0) {
            console.error('‚ùå No hay datos de heatmap disponibles');
            return;
        }
        
        // Preparar datos en formato [dia, semana, valor]
        const data = datosHeatmap.map(item => [
            item.dia,
            item.semana,
            item.valor
        ]);
        
        // Encontrar valor m√°ximo para escalar colores
        const maxValor = Math.max(...datosHeatmap.map(d => d.valor));
        
        try {
            const myChart = echarts.init(container);
            
            const option = {
                tooltip: {
                    position: 'top',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    textStyle: {
                        color: '#fff',
                        fontSize: 13
                    },
                    formatter: function(params) {
                        const item = datosHeatmap[params.dataIndex];
                        return `
                            <div style="padding: 5px;">
                                <strong>${diasLabels[item.dia]} - ${semanasLabels[item.semana]}</strong><br/>
                                Venta promedio: <strong>S/ ${item.valor.toLocaleString('es-PE', {maximumFractionDigits: 0})}</strong><br/>
                                Total: S/ ${item.total.toLocaleString('es-PE', {maximumFractionDigits: 0})}<br/>
                                Transacciones: ${item.transacciones}
                            </div>
                        `;
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    top: '10%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: diasLabels,
                    splitArea: {
                        show: true
                    },
                    axisLabel: {
                        fontSize: 12,
                        fontWeight: '500'
                    }
                },
                yAxis: {
                    type: 'category',
                    data: semanasLabels,
                    splitArea: {
                        show: true
                    },
                    axisLabel: {
                        fontSize: 12,
                        fontWeight: '500'
                    }
                },
                visualMap: {
                    min: 0,
                    max: maxValor,
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '0%',
                    inRange: {
                        color: ['#f0f9ff', '#bae7ff', '#69c0ff', '#1890ff', '#0050b3', '#003a8c']
                    },
                    textStyle: {
                        fontSize: 11
                    },
                    formatter: function(value) {
                        return 'S/ ' + (value / 1000).toFixed(0) + 'K';
                    }
                },
                series: [{
                    name: 'Ventas',
                    type: 'heatmap',
                    data: data,
                    label: {
                        show: false
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            myChart.setOption(option);
            console.log('‚úÖ Heatmap de actividad creado exitosamente');
        } catch (error) {
            console.error('‚ùå Error al crear heatmap:', error);
        }
    }

<<<<<<< HEAD
    // --- INICIO: L√≥gica mejorada para Mapa Geogr√°fico con filtros ---

    // Mantener una referencia a la instancia del gr√°fico para no reiniciarla innecesariamente
    let mapaGeograficoChart = null;

    // Funci√≥n para buscar datos del mapa en el backend seg√∫n los filtros aplicados
    async function fetchMapaData(filters) {
        console.log('üó∫Ô∏è Buscando nuevos datos del mapa con filtros:', filters);
        
        const params = new URLSearchParams(filters);
        // Este endpoint DEBE ser creado en tu backend (Flask/Python).
        // Debe consultar Odoo usando los filtros y devolver un JSON con el formato:
        // [{name: 'LIMA', value: 123456}, {name: 'AREQUIPA', value: 78901}, ...]
        // La clave 'name' debe coincidir con la propiedad 'NOMBDEP' del archivo GeoJSON.
        const endpoint = `/api/mapa_ventas?${params.toString()}`;
        
        try {
            const response = await fetch(endpoint);
            if (!response.ok) {
                throw new Error(`Error HTTP! estado: ${response.status}`);
            }
            const data = await response.json();
            console.log('üó∫Ô∏è Nuevos datos del mapa recibidos:', data);
            return data;
        } catch (error) {
            console.error('‚ùå Error al buscar datos del mapa:', error);
            const container = document.getElementById('graficoMapaGeografico');
            if (container) {
                container.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #c0392b;">Error al cargar datos del mapa.</div>`;
            }
            return null;
        }
    }

    // Funci√≥n que dibuja o actualiza el mapa con los datos proporcionados
    function dibujarMapaGeografico(container, peruJson, datosMapa) {
        if (!mapaGeograficoChart) {
            mapaGeograficoChart = echarts.init(container);
            echarts.registerMap('PERU', peruJson);
        }

        // Si no hay datos, mostrar un mensaje claro en el gr√°fico en lugar de un mapa vac√≠o.
        if (!datosMapa || datosMapa.length === 0) {
            console.warn('üó∫Ô∏è No hay datos para dibujar en el mapa. Mostrando mensaje de "Sin datos".');
            mapaGeograficoChart.setOption({
                title: {
                    text: 'No se encontraron datos para los filtros seleccionados',
                    left: 'center',
                    top: 'middle',
                    textStyle: {
                        color: '#888',
                        fontSize: 16,
                        fontWeight: 'normal'
                    }
                },
                // Limpiar cualquier serie o visualMap anterior para asegurar que el mapa desaparezca
                series: [],
                visualMap: null
            }, true); // `true` para limpiar el canvas completamente
            return; // Detener la ejecuci√≥n aqu√≠
        }

        // FIX: Normalizar nombres de departamentos usando la funci√≥n normalizarNombre
        // que elimina "(PE)" y otros sufijos, y normaliza tildes
        const ventasMap = new Map();
        datosMapa.forEach(d => {
            const nombreNormalizado = normalizarNombre(d.name);
            if (nombreNormalizado) {
                ventasMap.set(nombreNormalizado, d.value || 0);
            }
        });
        
        // Crear datos mapeados desde el GeoJSON hacia los datos de ventas
        const datosMapaNormalizados = peruJson.features.map(feature => {
            const nombreGeoJson = feature.properties.NOMBDEP;
            const nombreNormalizado = normalizarNombre(nombreGeoJson);
            const valorVenta = ventasMap.get(nombreNormalizado) || 0;
            
            return {
                name: nombreGeoJson,
                value: valorVenta
            };
        });
        
        console.log('üó∫Ô∏è Datos del mapa normalizados:', datosMapaNormalizados);

        // Calcular percentiles para categorizaci√≥n tipo sem√°foro
        // Ordenar valores de mayor a menor para calcular percentiles correctamente
        const valoresVentas = datosMapaNormalizados.map(d => d.value).filter(v => v > 0).sort((a, b) => b - a);
        const totalValores = valoresVentas.length;
        
        let percentil33 = 0; // Top 33% (valores m√°s altos)
        let percentil66 = 0; // Entre 33% y 66% (valores medios)
        
        if (totalValores > 0) {
            // El percentil 33 es el valor en la posici√≥n que separa el top 33%
            const indice33 = Math.max(0, Math.floor(totalValores * 0.33) - 1);
            // El percentil 66 es el valor en la posici√≥n que separa el 33%-66%
            const indice66 = Math.max(0, Math.floor(totalValores * 0.66) - 1);
            percentil33 = valoresVentas[indice33] || 0;
            percentil66 = valoresVentas[indice66] || 0;
        }
        
        // Categorizar cada provincia
        let countAlta = 0, countMedia = 0, countBaja = 0;
        
        const datosMapaCategorizados = datosMapaNormalizados.map(d => {
            let categoria = 'baja';
            let categoriaLabel = 'Baja Penetraci√≥n';
            
            if (d.value === 0) {
                categoria = 'baja';
                categoriaLabel = 'Sin Ventas';
                countBaja++;
            } else if (d.value >= percentil33) {
                // Top 33% - Alta penetraci√≥n
                categoria = 'alta';
                categoriaLabel = 'Alta Penetraci√≥n';
                countAlta++;
            } else if (d.value >= percentil66) {
                // Entre 33% y 66% - Media penetraci√≥n
                categoria = 'media';
                categoriaLabel = 'Media Penetraci√≥n';
                countMedia++;
            } else {
                // Bottom 33% - Baja penetraci√≥n
                categoria = 'baja';
                categoriaLabel = 'Baja Penetraci√≥n';
                countBaja++;
            }
            
            return {
                ...d,
                categoria: categoria,
                categoriaLabel: categoriaLabel
            };
        });
        
        // Actualizar el resumen estad√≠stico
        const countAltaEl = document.getElementById('count-alta');
        const countMediaEl = document.getElementById('count-media');
        const countBajaEl = document.getElementById('count-baja');
        if (countAltaEl) countAltaEl.textContent = countAlta;
        if (countMediaEl) countMediaEl.textContent = countMedia;
        if (countBajaEl) countBajaEl.textContent = countBaja;

        const maxValor = Math.max(...datosMapaNormalizados.map(d => d.value));

        const option = {
            // Asegurarse de que no haya un t√≠tulo de "sin datos" si ahora s√≠ hay datos
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'item',
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                textStyle: {
                    color: '#fff',
                    fontSize: 13
                },
                formatter: function(params) {
                    const data = params.data || {};
                    if (data && typeof data.value !== 'undefined') {
                        const categoria = data.categoriaLabel || 'Sin categor√≠a';
                        const icono = data.categoria === 'alta' ? 'üü¢' : (data.categoria === 'media' ? 'üü°' : 'üî¥');
                        let tooltipHtml = `<div style="padding: 5px;"><strong>${params.name}</strong><br/>`;
                        tooltipHtml += `${icono} <strong>${categoria}</strong><br/>`;
                        tooltipHtml += `Venta: <strong>S/ ${data.value.toLocaleString('es-PE', {maximumFractionDigits: 0})}</strong>`;
                        
                        // Si el backend env√≠a el n√∫mero de pedidos, lo mostramos
                        if (typeof data.pedidos !== 'undefined') {
                            tooltipHtml += `<br/>N¬∞ Pedidos: <strong>${data.pedidos}</strong>`;
                        }
                        
                        tooltipHtml += `</div>`;
                        return tooltipHtml;
                    }
                    return `<div style="padding: 5px;"><strong>${params.name}</strong><br/>üî¥ Sin ventas registradas</div>`;
                }
            },
            visualMap: {
                min: 0,
                max: maxValor > 0 ? maxValor : 1,
                type: 'piecewise',
                pieces: [
                    {min: percentil33, max: Infinity, label: 'Alta Penetraci√≥n', color: '#52c41a'},
                    {min: percentil66, max: percentil33, label: 'Media Penetraci√≥n', color: '#faad14'},
                    {min: 0.01, max: percentil66, label: 'Baja Penetraci√≥n', color: '#ff4d4f'},
                    {value: 0, label: 'Sin Ventas', color: '#d9d9d9'}
                ],
                left: 'left',
                top: 'bottom',
                text: ['Alta', 'Baja'],
                textStyle: {
                    color: '#333',
                    fontSize: 11
                },
                calculable: false,
                itemWidth: 15,
                itemHeight: 10
            },
            series: [{
                name: 'Ventas por Departamento',
                type: 'map',
                map: 'PERU',
                nameProperty: 'NOMBDEP',
                roam: true,
                label: { show: false },
                emphasis: {
                    label: { show: true, color: '#000', fontWeight: 'bold', fontSize: 12 },
                    itemStyle: {
                        borderColor: '#000',
                        borderWidth: 2
                    }
                },
                itemStyle: {
                    borderColor: '#fff',
                    borderWidth: 1
                },
                data: datosMapaCategorizados
            }]
        };
        mapaGeograficoChart.setOption(option, true); // `true` para limpiar opciones previas
        console.log('‚úÖ Mapa geogr√°fico dibujado/actualizado exitosamente');
    }

    // Funci√≥n principal que inicializa el mapa y la l√≥gica de los filtros
    async function inicializarMapaGeografico() {
        console.log('üó∫Ô∏è Creando mapa geogr√°fico de ventas...');
        const container = document.getElementById('graficoMapaGeografico');
        if (!container) {
            console.error('‚ùå Contenedor graficoMapaGeografico no encontrado');
            return;
        }
        
        const datosInicialesMapa = {{ mapa_ventas_data|default([])|tojson|safe }};
        
        if (!datosInicialesMapa || datosInicialesMapa.length === 0) {
            container.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; background: #f8f9fa; border-radius: 8px;">No hay datos geogr√°ficos para mostrar en el mapa.</div>';
            return;
        }

        try {
            const response = await fetch('https://raw.githubusercontent.com/juaneladio/peru-geojson/master/peru_departamental_simple.geojson');
            const peruJson = await response.json();
            
            // Dibujar el mapa inicial
            dibujarMapaGeografico(container, peruJson, datosInicialesMapa);

            // Configurar el listener para el bot√≥n de filtros
            const aplicarFiltrosBtn = document.getElementById('mapa-aplicar-filtros');
            if (aplicarFiltrosBtn) {
                aplicarFiltrosBtn.addEventListener('click', async () => {
                    aplicarFiltrosBtn.disabled = true;
                    aplicarFiltrosBtn.textContent = 'Cargando...';

                    const filters = {
                        line_commercial_zone_id: document.getElementById('mapa-linea-comercial').value,
                        groups_ids: document.getElementById('mapa-grupo').value,
                        zona_id: document.getElementById('mapa-zona').value,
                        mes: '{{ mes_seleccionado }}',
                        dia_fin: '{{ dia_actual }}'
                    };
                    
                    // Limpiar filtros vac√≠os antes de enviar
                    Object.keys(filters).forEach(key => (filters[key] === '' || filters[key] === null) && delete filters[key]);

                    const nuevosDatosMapa = await fetchMapaData(filters);
                    // La petici√≥n puede fallar (devuelve null) o tener √©xito pero sin datos (devuelve [])
                    // En ambos casos, queremos actualizar la UI.
                    if (nuevosDatosMapa !== null) {
                        dibujarMapaGeografico(container, peruJson, nuevosDatosMapa);
                    }
                    
                    aplicarFiltrosBtn.disabled = false;
                    aplicarFiltrosBtn.textContent = 'Aplicar';
                });
            }
        } catch (error) {
            console.error('‚ùå Error al cargar el archivo GeoJSON de Per√∫:', error);
            container.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #c0392b; background: #f8f9fa; border-radius: 8px;">Error al cargar el mapa. Verifique la conexi√≥n a internet.</div>';
        }
    }
    // --- FIN: L√≥gica mejorada para Mapa Geogr√°fico ---
=======
    // Funci√≥n para crear el mapa geogr√°fico de penetraci√≥n
    function crearGraficoMapaGeografico() {
        console.log('üó∫Ô∏è Creando mapa geogr√°fico de penetraci√≥n...');
        
        const container = document.getElementById('graficoMapaGeografico');
        if (!container) {
            console.error('‚ùå Contenedor #graficoMapaGeografico no encontrado');
            return;
        }
        
        // Obtener datos de regiones desde Jinja
        const datosRegiones = {{ datos_geograficos | tojson | safe }};
        
        if (!datosRegiones || datosRegiones.length === 0) {
            console.warn('‚ö†Ô∏è No hay datos geogr√°ficos disponibles');
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No hay datos disponibles</div>';
            return;
        }
        
        console.log(`üìä Datos geogr√°ficos cargados: ${datosRegiones.length} regiones`);
        
        // Preparar datos para el gr√°fico de barras
        const regiones = datosRegiones.map(d => d.region);
        const ventas = datosRegiones.map(d => d.ventas);
        const clientes = datosRegiones.map(d => d.clientes);
        const participacion = datosRegiones.map(d => d.participacion);
        
        // Encontrar valores m√°ximos para escalar colores
        const maxVentas = Math.max(...ventas);
        
        try {
            const myChart = echarts.init(container);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    borderColor: '#1890ff',
                    borderWidth: 1,
                    textStyle: {
                        color: '#fff',
                        fontSize: 13
                    },
                    formatter: function(params) {
                        const idx = params[0].dataIndex;
                        const region = datosRegiones[idx];
                        return `
                            <div style="padding: 8px;">
                                <div style="font-weight: 700; font-size: 14px; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 6px;">
                                    üó∫Ô∏è ${region.region}
                                </div>
                                <div style="margin: 4px 0;">
                                    üí∞ <strong>Ventas:</strong> S/ ${region.ventas.toLocaleString('es-PE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                </div>
                                <div style="margin: 4px 0;">
                                    üë• <strong>Clientes:</strong> ${region.clientes}
                                </div>
                                <div style="margin: 4px 0;">
                                    üì¶ <strong>Transacciones:</strong> ${region.transacciones}
                                </div>
                                <div style="margin: 4px 0;">
                                    üìä <strong>Participaci√≥n:</strong> ${region.participacion.toFixed(1)}%
                                </div>
                                <div style="margin: 4px 0;">
                                    üé´ <strong>Ticket Promedio:</strong> S/ ${region.ticket_promedio.toLocaleString('es-PE', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                </div>
                            </div>
                        `;
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '3%',
                    top: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    name: 'Ventas (S/)',
                    nameLocation: 'middle',
                    nameGap: 30,
                    nameTextStyle: {
                        fontSize: 13,
                        fontWeight: 600,
                        color: '#666'
                    },
                    axisLabel: {
                        formatter: function(value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                            return value;
                        },
                        fontSize: 12,
                        color: '#666'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f0f0f0',
                            type: 'dashed'
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: regiones,
                    axisLabel: {
                        fontSize: 12,
                        color: '#333',
                        fontWeight: 500,
                        formatter: function(value) {
                            // Truncar nombres muy largos
                            if (value.length > 20) {
                                return value.substring(0, 18) + '...';
                            }
                            return value;
                        }
                    },
                    axisTick: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#e8e8e8'
                        }
                    }
                },
                series: [
                    {
                        name: 'Ventas por Regi√≥n',
                        type: 'bar',
                        data: ventas.map((value, idx) => {
                            // Calcular intensidad de color basada en ventas
                            const intensidad = value / maxVentas;
                            let color;
                            
                            if (intensidad > 0.7) {
                                color = '#52c41a';  // Verde intenso (alta penetraci√≥n)
                            } else if (intensidad > 0.4) {
                                color = '#1890ff';  // Azul (penetraci√≥n media)
                            } else if (intensidad > 0.2) {
                                color = '#faad14';  // Naranja (penetraci√≥n baja)
                            } else {
                                color = '#ff4d4f';  // Rojo (oportunidad - zona blanca)
                            }
                            
                            return {
                                value: value,
                                itemStyle: {
                                    color: color,
                                    borderRadius: [0, 4, 4, 0]
                                }
                            };
                        }),
                        barMaxWidth: 30,
                        label: {
                            show: true,
                            position: 'right',
                            formatter: function(params) {
                                const idx = params.dataIndex;
                                const region = datosRegiones[idx];
                                return `${region.participacion.toFixed(1)}%`;
                            },
                            fontSize: 11,
                            fontWeight: 600,
                            color: '#666'
                        },
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.3)'
                            }
                        }
                    }
                ]
            };
            
            myChart.setOption(option);
            console.log('‚úÖ Mapa geogr√°fico creado exitosamente');
            
            // Hacer responsive
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        } catch (error) {
            console.error('‚ùå Error al crear mapa geogr√°fico:', error);
        }
    }
>>>>>>> 8880ed7fe8e309d92ca2833d029c9f8d287e1631

    // Inicializar gr√°ficos
    crearGraficoFrecuenciaLinea();   // Frecuencia por l√≠nea comercial
    try {
        crearGraficoTendencia12Meses();
    } catch(e) { console.error('Error creando gr√°fico tendencia:', e); }

    try {
        crearGraficoMapaGeografico();
    } catch(e) { console.error('Error creando mapa geogr√°fico:', e); }
    crearGraficoSegmentosRFM();      // Segmentaci√≥n RFM
    crearGraficoHeatmapVentas();     // Heatmap de actividad
    crearGraficoMapaGeografico();    // Mapa geogr√°fico de penetraci√≥n
    
    console.log('‚úÖ Todos los gr√°ficos inicializados');
    inicializarMapaGeografico();    // Mapa geogr√°fico de ventas con filtros

    /*
    // Inicializar selector de l√≠neas para el gr√°fico apilado
    const allLines = allStackedChartData['Forma Farmac√©utica'].yAxis.map(line => ({ value: line, text: line }));
    lineSelector = new TomSelect('#line-selector', {
        plugins: ['remove_button'],
        placeholder: 'Comparar l√≠neas...',
        options: allLines,
        onChange: function() {
            updateStackedChart();,
        placeholder: 'Comparar l√≠neas...'
        options: allLines,
        onChange: function() {
            updateStackedChart();,
        placeholder: 'Comparar l√≠neas...'
        options: allLines,
        onChange: function() {
            updateStackedChart();
        }
    });
    lineSelector.setValue(allLines.map(l => l.value)); // Seleccionar todo por defecto

    updateStackedChart(); // Carga inicial del nuevo gr√°fico
  } */
});
</script>

{% endblock %}